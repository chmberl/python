<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>多数据库 — Django 1.8.2 中文文档</title>
<link href="../../_static/default.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.8.2.dev20150513143415',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<link href="../../index.html" rel="top" title="Django 1.8.2.dev20150513143415 documentation"/>
<link href="index.html" rel="up" title="Models and databases"/>
<link href="tablespaces.html" rel="next" title="Tablespaces"/>
<link href="transactions.html" rel="prev" title="Database transactions"/>
<script src="http://python.usyiyi.cn/django/templatebuiltins.js" type="text/javascript"></script>
<script type="text/javascript">
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='http://python.usyiyi.cn/django/topics/db/&quot;&#32;+&#32;base&#32;+&#32;&quot;#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='http://python.usyiyi.cn/django/topics/db/&quot;&#32;+&#32;base&#32;+&#32;&quot;#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);
</script>
</head>
<body>
<div class="document">
<div class="yui-t6" id="custom-doc">
<div id="hd">
<h1><font id="158">Django 1.8.2 文档</font></h1>
<div id="global-nav">
<a href="../../index.html" title="Home page">Home</a>  |
        <a href="../../contents.html" title="Table of contents">Table of contents</a>  |
        <a href="../../genindex.html" title="Global index">Index</a>  |
        <a href="../../py-modindex.html" title="Module index">Modules</a>
</div>
<div class="nav">
    « <a href="transactions.html" title="Database transactions">previous</a>
     |
    <a accesskey="U" href="../index.html" title="Using Django">up</a>
   |
    <a href="tablespaces.html" title="Tablespaces">next</a> »</div>
</div>
<div id="bd">
<div id="yui-main">
<div class="yui-b">
<div class="yui-g" id="topics-db-multi-db">
<div class="section" id="s-multiple-databases">
<span id="multiple-databases"></span><h1><font id="159">多数据库</font><a class="headerlink" href="multi-db.html#multiple-databases" title="Permalink to this headline">¶</a></h1>
<p><font id="1">这篇主题描述Django 对多个数据库的支持。</font><font id="2">大部分Django 文档假设你只和一个数据库打交道。</font><font id="3">如果你想与多个数据库打交道，你将需要一些额外的步骤。</font></p>
<div class="section" id="s-defining-your-databases">
<span id="defining-your-databases"></span><h2><font id="160">定义你的数据库</font><a class="headerlink" href="multi-db.html#defining-your-databases" title="Permalink to this headline">¶</a></h2>
<p><font id="4">在Django中使用多个数据库的第一步是告诉Django 你将要使用的数据库服务器。</font><font id="5">这通过使用<a class="reference internal" href="../../ref/settings.html#std:setting-DATABASES"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASES</span></tt></a> 设置完成。</font><font id="6">该设置映射数据库别名到一个数据库连接设置的字典，这是整个Django 中引用一个数据库的方式。</font><font id="7">字典中的设置在 <a class="reference internal" href="../../ref/settings.html#std:setting-DATABASES"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASES</span></tt></a> 文档中有完整描述。</font></p>
<p><font id="8">你可以为数据库选择任何别名。</font><font id="9">然而，<tt class="docutils literal"><span class="pre">default</span></tt>这个别名具有特殊的含义。</font><font id="10">当没有选择其它数据库时，Django 使用具有<tt class="docutils literal"><span class="pre">default</span></tt> 别名的数据库。</font></p>
<p><font id="11">下面是<tt class="docutils literal"><span class="pre">settings.py</span></tt>的一个示例片段，它定义两个数据库 —— 一个默认的PostgreSQL 数据库和一个叫做<tt class="docutils literal"><span class="pre">users</span></tt>的MySQL 数据库：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'app_data'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'postgres_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'s3krit'</span>
    <span class="p">},</span>
    <span class="s">'users'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'user_data'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'priv4te'</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><font id="12">如果<tt class="docutils literal"><span class="pre">default</span></tt> 数据库在你的项目中不合适，你需要小心地永远指定是想使用的数据库。</font><font id="13">Django 要求<tt class="docutils literal"><span class="pre">default</span></tt> 数据库必须定义，但是其参数字典可以保留为空如果不使用它。</font><font id="14">若要这样做，你必须为你的所有的应用的模型建立<a class="reference internal" href="../../ref/settings.html#std:setting-DATABASE_ROUTERS"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASE_ROUTERS</span></tt></a>，包括正在使用的contrib 中的应用和第三方应用，以使得不会有查询被路由到默认的数据库。</font><font id="15">下面是<tt class="docutils literal"><span class="pre">settings.py</span></tt> 的一个示例片段，它定义两个非默认的数据库，其中<tt class="docutils literal"><span class="pre">default</span></tt> 有意保留为空：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s">'users'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'user_data'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'superS3cret'</span>
    <span class="p">},</span>
    <span class="s">'customers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'customer_data'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_cust'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'veryPriv@ate'</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><font id="16">如果你试图访问在<a class="reference internal" href="../../ref/settings.html#std:setting-DATABASES"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASES</span></tt></a> 设置中没有定义的数据库，Django 将抛出一个<tt class="docutils literal"><span class="pre">django.db.utils.ConnectionDoesNotExist</span></tt>异常。</font></p>
</div>
<div class="section" id="s-synchronizing-your-databases">
<span id="synchronizing-your-databases"></span><h2><font id="161">同步你的数据库</font><a class="headerlink" href="multi-db.html#synchronizing-your-databases" title="Permalink to this headline">¶</a></h2>
<p><font id="17"><a class="reference internal" href="../../ref/django-admin.html#django-admin-migrate"><tt class="xref std std-djadmin docutils literal"><span class="pre">migrate</span></tt></a> 管理命令一次操作一个数据库。</font><font id="18">默认情况下，它在<tt class="docutils literal"><span class="pre">default</span></tt> 数据库上操作，但是通过提供一个<a class="reference internal" href="../../ref/django-admin.html#django-admin-option---database"><tt class="xref std std-djadminopt docutils literal"><span class="pre">--database</span></tt></a> 参数，你可以告诉<a class="reference internal" href="../../ref/django-admin.html#django-admin-migrate"><tt class="xref std std-djadmin docutils literal"><span class="pre">migrate</span></tt></a> 同步一个不同的数据库。</font><font id="19">因此，为了同步所有模型到我们示例中的所有数据库，你将需要调用：</font></p>
<div class="highlight-python"><div class="highlight"><pre>$ ./manage.py migrate
$ ./manage.py migrate --database=users
</pre></div>
</div>
<p><font id="20">如果你不想每个应用都被同步到同一台数据库上，你可以定义一个<a class="reference internal" href="multi-db.html#topics-db-multi-db-routing"><em>数据库路由</em></a>，它实现一个策略来控制特定模型的访问性。</font></p>
<div class="section" id="s-using-other-management-commands">
<span id="using-other-management-commands"></span><h3><font id="166">使用其它管理命令</font><a class="headerlink" href="multi-db.html#using-other-management-commands" title="Permalink to this headline">¶</a></h3>
<p><font id="21">其它<tt class="docutils literal"><span class="pre">django-admin</span></tt> 命令与数据库交互的方式与<a class="reference internal" href="../../ref/django-admin.html#django-admin-migrate"><tt class="xref std std-djadmin docutils literal"><span class="pre">migrate</span></tt></a>相同 —— 它们都一次只操作一个数据库，并使用<a class="reference internal" href="../../ref/django-admin.html#django-admin-option---database"><tt class="xref std std-djadminopt docutils literal"><span class="pre">--database</span></tt></a>来控制使用的数据库。</font></p>
</div>
</div>
<div class="section" id="s-automatic-database-routing">
<span id="s-topics-db-multi-db-routing"></span><span id="automatic-database-routing"></span><span id="topics-db-multi-db-routing"></span><h2><font id="162">数据库自动路由</font><a class="headerlink" href="multi-db.html#automatic-database-routing" title="Permalink to this headline">¶</a></h2>
<p><font id="22">使用多数据库最简单的方法是建立一个数据库路由模式。</font><font id="23">默认的路由模式确保对象’粘滞‘在它们原始的数据库上（例如，从<tt class="docutils literal"><span class="pre">foo</span></tt> 数据库中获取的对象将保存在同一个数据库中）。</font><font id="24">默认的路由模式还确保如果没有指明数据库，所有的查询都回归到<tt class="docutils literal"><span class="pre">default</span></tt>数据库中。</font></p>
<p><font id="25">你不需要做任何事情来激活默认的路由模式 —— 它在每个Django项目上’直接‘提供。</font><font id="26">然而，如果你想实现更有趣的数据库分配行为，你可以定义并安装你自己的数据库路由。</font></p>
<div class="section" id="s-database-routers">
<span id="database-routers"></span><h3><font id="167">数据库路由</font><a class="headerlink" href="multi-db.html#database-routers" title="Permalink to this headline">¶</a></h3>
<p><font id="27">数据库路由是一个类，它提供4个方法：</font></p>
<dl class="method">
<dt id="db_for_read">
<tt class="descname">db_for_read</tt>(<em>model</em>, <em>**hints</em>)<a class="headerlink" href="multi-db.html#db_for_read" title="Permalink to this definition">¶</a></dt>
<dd><p><font id="28">建议<tt class="docutils literal"><span class="pre">model</span></tt>类型的对象的读操作应该使用的数据库。</font></p>
<p><font id="29">如果一个数据库操作能够提供其它额外的信息可以帮助选择一个数据库，它将在<tt class="docutils literal"><span class="pre">hints</span></tt>字典中提供。</font><font id="30">合法的hints 的详细信息在<a class="reference internal" href="multi-db.html#topics-db-multi-db-hints"><em>下文</em></a>给出。</font></p>
<p><font id="31">如果没有建议，则返回<tt class="docutils literal"><span class="pre">None</span></tt>。</font></p>
</dd></dl>
<dl class="method">
<dt id="db_for_write">
<tt class="descname">db_for_write</tt>(<em>model</em>, <em>**hints</em>)<a class="headerlink" href="multi-db.html#db_for_write" title="Permalink to this definition">¶</a></dt>
<dd><p><font id="32">建议Model 类型的对象的写操作应该使用的数据库。</font></p>
<p><font id="33">如果一个数据库操作能够提供其它额外的信息可以帮助选择一个数据库，它将在<tt class="docutils literal"><span class="pre">hints</span></tt>字典中提供。 </font><font id="34">合法的hints 的详细信息在<a class="reference internal" href="multi-db.html#topics-db-multi-db-hints"><em>下文</em></a>给出。</font></p>
<p><font id="35">如果没有建议，则返回<tt class="docutils literal"><span class="pre">None</span></tt>。</font></p>
</dd></dl>
<dl class="method">
<dt id="allow_relation">
<tt class="descname">allow_relation</tt>(<em>obj1</em>, <em>obj2</em>, <em>**hints</em>)<a class="headerlink" href="multi-db.html#allow_relation" title="Permalink to this definition">¶</a></dt>
<dd><p><font id="36">如果<tt class="docutils literal"><span class="pre">obj1</span></tt> 和<tt class="docutils literal"><span class="pre">obj2</span></tt> 之间应该允许关联则返回<tt class="docutils literal"><span class="pre">True</span></tt>，如果应该防止关联则返回<tt class="docutils literal"><span class="pre">False</span></tt>，如果路由无法判断则返回<tt class="docutils literal"><span class="pre">None</span></tt>。</font><font id="37">这是纯粹的验证操作，外键和多对多操作使用它来决定两个对象之间是否应该允许一个关联。</font></p>
</dd></dl>
<dl class="method">
<dt id="allow_migrate">
<tt class="descname">allow_migrate</tt>(<em>db</em>, <em>app_label</em>, <em>model_name=None</em>, <em>**hints</em>)<a class="headerlink" href="multi-db.html#allow_migrate" title="Permalink to this definition">¶</a></dt>
<dd><p><font id="38">定义迁移操作是否允许在别名为<tt class="docutils literal"><span class="pre">db</span></tt>的数据库上运行。</font><font id="39">如果操作应该运行则返回<tt class="docutils literal"><span class="pre">True</span></tt> ，如果不应该运行则返回<tt class="docutils literal"><span class="pre">False</span></tt>，如果路由无法判断则返回<tt class="docutils literal"><span class="pre">None</span></tt>。</font></p>
<p><font id="40">位置参数<tt class="docutils literal"><span class="pre">app_label</span></tt> 是正在迁移的应用的标签。</font></p>
<p><font id="41">大部分迁移操作设置<tt class="docutils literal"><span class="pre">model_name</span></tt>的值为正在迁移的模型的<tt class="docutils literal"><span class="pre">model._meta.model_name</span></tt>（模型的<tt class="docutils literal"><span class="pre">__name__</span></tt> 的小写）。</font><font id="42">对于<a class="reference internal" href="../../ref/migration-operations.html#django.db.migrations.operations.RunPython" title="django.db.migrations.operations.RunPython"><tt class="xref py py-class docutils literal"><span class="pre">RunPython</span></tt></a>和<a class="reference internal" href="../../ref/migration-operations.html#django.db.migrations.operations.RunSQL" title="django.db.migrations.operations.RunSQL"><tt class="xref py py-class docutils literal"><span class="pre">RunSQL</span></tt></a> 操作它的值为<tt class="docutils literal"><span class="pre">None</span></tt>，除非这两个操作使用hint 提供它。</font></p>
<p><font id="43"><tt class="docutils literal"><span class="pre">hints</span></tt> 用于某些操作来传递额外的信息给路由。</font></p>
<p><font id="44">当设置了<tt class="docutils literal"><span class="pre">model_name</span></tt>时，<tt class="docutils literal"><span class="pre">hints</span></tt> 通常通过键<tt class="docutils literal"><span class="pre">'model'</span></tt>包含该模型的类。</font><font id="45">注意，它可能是一个<a class="reference internal" href="../migrations.html#historical-models"><em>历史模型</em></a>，因此不会有自定的属性、方法或管理器。</font><font id="46">你应该只依赖<tt class="docutils literal"><span class="pre">_meta</span></tt>。</font></p>
<p><font id="47">这个方法还可以用来决定一个给定数据库上某个模型的可用性。</font></p>
<p><font id="48">注意，如果这个方法返回<tt class="docutils literal"><span class="pre">False</span></tt>，迁移将默默地不会在模型上做任何操作。</font><font id="49">这可能导致你应用某些操作之后出现损坏的外键、表多余或者缺失。</font></p>
<div class="versionchanged">
<span class="title">Changed in Django 1.8:</span> <p><font id="50">The signature of <tt class="docutils literal"><span class="pre">allow_migrate</span></tt> has changed significantly from previous versions. </font><font id="51">See the <a class="reference internal" href="http://python.usyiyi.cn/django/releases/1.8.html#deprecated-signature-of-allow-migrate"><em>deprecation notes</em></a> for more details.</font></p>
</div>
</dd></dl>
<p><font id="52">路由不必提供<em>所有</em>这些方法 —— 它可以省略一个或多个。</font><font id="53">如果某个方法缺失，在做相应的检查时Django 将忽略该路由。</font></p>
<div class="section" id="s-hints">
<span id="s-topics-db-multi-db-hints"></span><span id="hints"></span><span id="topics-db-multi-db-hints"></span><h4><font id="182">Hints</font><a class="headerlink" href="multi-db.html#hints" title="Permalink to this headline">¶</a></h4>
<p><font id="54">Hint 由数据库路由接收，用于决定哪个数据库应该接收一个给定的请求。</font></p>
<p><font id="55">目前，唯一一个提供的hint 是<tt class="docutils literal"><span class="pre">instance</span></tt>，它是一个对象实例，与正在进行的读或者写操作关联。</font><font id="56">This might be the instance that is being saved, or it might be an instance that is being added in a many-to-many relation. </font><font id="57">In some cases, no instance hint will be provided at all. </font><font id="58">The router checks for the existence of an instance hint, and determine if that hint should be used to alter routing behavior.</font></p>
</div>
</div>
<div class="section" id="s-using-routers">
<span id="using-routers"></span><h3><font id="168">使用路由</font><a class="headerlink" href="multi-db.html#using-routers" title="Permalink to this headline">¶</a></h3>
<p><font id="59">数据库路由使用<a class="reference internal" href="../../ref/settings.html#std:setting-DATABASE_ROUTERS"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASE_ROUTERS</span></tt></a> 设置安装。</font><font id="60">这个设置定义一个类名的列表，其中每个类表示一个路由，它们将被主路由（<tt class="docutils literal"><span class="pre">django.db.router</span></tt>）使用。</font></p>
<p><font id="61">Django 的数据库操作使用主路由来分配数据库的使用。</font><font id="62">每当一个查询需要知道使用哪一个数据库时，它将调用主路由，并提供一个模型和一个Hint （可选）。</font><font id="63">Django 然后依次测试每个路由直至找到一个数据库的建议。</font><font id="64">如果找不到建议，它将尝试Hint 实例的当前<tt class="docutils literal"><span class="pre">_state.db</span></tt>。</font><font id="65">如果没有提供Hint 实例，或者该实例当前没有数据库状态，主路由将分配<tt class="docutils literal"><span class="pre">default</span></tt> 数据库。</font></p>
</div>
<div class="section" id="s-an-example">
<span id="an-example"></span><h3><font id="169">一个例子</font><a class="headerlink" href="multi-db.html#an-example" title="Permalink to this headline">¶</a></h3>
<div class="admonition-example-purposes-only admonition">
<p class="first admonition-title"><font id="66">只是为了示例！</font></p>
<p><font id="67">这个例子的目的是演示如何使用路由这个基本结构来改变数据库的使用。</font><font id="68">它有意忽略一些复杂的问题，目的是为了演示如何使用路由。</font></p>
<p><font id="69">如果<tt class="docutils literal"><span class="pre">myapp</span></tt> 中的任何一个模型包含与<tt class="docutils literal"><span class="pre">其它</span></tt> 数据库之外的模型的关联，这个例子将不能工作。</font><font id="70"><a class="reference internal" href="multi-db.html#no-cross-database-relations"><em>跨数据的关联</em></a>引入引用完整性问题，Django目前还无法处理。</font></p>
<p class="last"><font id="71">Primary/replica（在某些数据库中叫做master/slave）配置也是有缺陷的 —— 它不提供任何处理Replication lag 的解决办法（例如，因为写入同步到replica 需要一定的时间，这会引入查询的不一致）。</font><font id="72">It also doesn’t consider the interaction of transactions with the database utilization strategy.</font></p>
</div>
<p><font id="73">那么 —— 在实际应用中这以为着什么？</font><font id="74">让我们看一下另外一个配置的例子。</font><font id="75">这个配置将有几个数据库：一个用于<tt class="docutils literal"><span class="pre">auth</span></tt> 应用，所有其它应用使用一个具有两个读replica 的 primary/replica。</font><font id="76">下面是表示这些数据库的设置：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'auth_db'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'auth_db'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'swordfish'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'primary'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'primary'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'spam'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'replica1'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'replica1'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'eggs'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'replica2'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'replica2'</span><span class="p">,</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="s">'mysql_user'</span><span class="p">,</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="s">'bacon'</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p><font id="77">现在我们将需要处理路由。</font><font id="78">首先，我们需要一个路由，它知道发送<tt class="docutils literal"><span class="pre">auth</span></tt> 应用的查询到<tt class="docutils literal"><span class="pre">auth_db</span></tt>：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AuthRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A router to control all database operations on models in the</span>
<span class="sd">    auth application.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Attempts to read auth models go to auth_db.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">'auth'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'auth_db'</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Attempts to write auth models go to auth_db.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">'auth'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'auth_db'</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Allow relations if a model in the auth app is involved.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">obj1</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">'auth'</span> <span class="ow">or</span> \
           <span class="n">obj2</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">'auth'</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Make sure the auth app only appears in the 'auth_db'</span>
<span class="sd">        database.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">app_label</span> <span class="o">==</span> <span class="s">'auth'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">db</span> <span class="o">==</span> <span class="s">'auth_db'</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
<p><font id="79">我们还需要一个路由，它发送所有其它应用的查询到primary/replica 配置，并随机选择一个replica 来读取：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">PrimaryReplicaRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Reads go to a randomly-chosen replica.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s">'replica1'</span><span class="p">,</span> <span class="s">'replica2'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Writes always go to primary.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="s">'primary'</span>

    <span class="k">def</span> <span class="nf">allow_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Relations between objects are allowed if both objects are</span>
<span class="sd">        in the primary/replica pool.</span>
<span class="sd">        """</span>
        <span class="n">db_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">'primary'</span><span class="p">,</span> <span class="s">'replica1'</span><span class="p">,</span> <span class="s">'replica2'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj1</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">in</span> <span class="n">db_list</span> <span class="ow">and</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">in</span> <span class="n">db_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        All non-auth models end up in this pool.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">True</span>
</pre></div>
</div>
<p><font id="80">最后，在设置文件中，我们添加如下内容（替换<tt class="docutils literal"><span class="pre">path.to.</span></tt>为该路由定义所在的真正路径）：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DATABASE_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'path.to.AuthRouter'</span><span class="p">,</span> <span class="s">'path.to.PrimaryReplicaRouter'</span><span class="p">]</span>
</pre></div>
</div>
<p><font id="81">路由处理的顺序非常重要。</font><font id="82">路由的查询将按照<a class="reference internal" href="../../ref/settings.html#std:setting-DATABASE_ROUTERS"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASE_ROUTERS</span></tt></a>设置中列出的顺序进行。</font><font id="83">在这个例子中，<tt class="docutils literal"><span class="pre">AuthRouter</span></tt>在<tt class="docutils literal"><span class="pre">PrimaryReplicaRouter</span></tt>之前处理，因此<tt class="docutils literal"><span class="pre">auth</span></tt>中的模型的查询处理在其它模型之前。</font><font id="84">如果<a class="reference internal" href="../../ref/settings.html#std:setting-DATABASE_ROUTERS"><tt class="xref std std-setting docutils literal"><span class="pre">DATABASE_ROUTERS</span></tt></a>设置按其它顺序列出这两个路由，<tt class="docutils literal"><span class="pre">PrimaryReplicaRouter.allow_migrate()</span></tt> 将先处理。</font><font id="85">PrimaryReplicaRouter 中实现的捕获所有的查询，这意味着所有的模型可以位于所有的数据库中。</font></p>
<p><font id="86">建立这个配置后，让我们运行一些Django 代码：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="c"># This retrieval will be performed on the 'auth_db' database</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fred</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'fred'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fred</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s">'Frederick'</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># This save will also be directed to 'auth_db'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fred</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># These retrieval will be randomly allocated to a replica database</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dna</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Douglas Adams'</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># A new object has no database allocation when created</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mh</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'Mostly Harmless'</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># This assignment will consult the router, and set mh onto</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># the same database as the author object</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mh</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">dna</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># This save will force the 'mh' instance onto the primary database...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mh</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># ... but if we re-retrieve the object, it will come back on a replica</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mh</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'Mostly Harmless'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="s-manually-selecting-a-database">
<span id="manually-selecting-a-database"></span><h2><font id="163">手动选择一个数据库</font><a class="headerlink" href="multi-db.html#manually-selecting-a-database" title="Permalink to this headline">¶</a></h2>
<p><font id="87">Django 还提供一个API，允许你在你的代码中完全控制数据库的使用。</font><font id="88">人工指定的数据库的优先级高于路由分配的数据库。</font></p>
<div class="section" id="s-manually-selecting-a-database-for-a-queryset">
<span id="manually-selecting-a-database-for-a-queryset"></span><h3><font id="170">为<tt class="docutils literal"><span class="pre">QuerySet</span></tt>手动选择一个数据库</font><a class="headerlink" href="multi-db.html#manually-selecting-a-database-for-a-queryset" title="Permalink to this headline">¶</a></h3>
<p><font id="89">你可以在<tt class="docutils literal"><span class="pre">QuerySet</span></tt>“链”的任意节点上为<tt class="docutils literal"><span class="pre">QuerySet</span></tt>选择数据库 。</font><font id="90">只需要在<tt class="docutils literal"><span class="pre">QuerySet</span></tt>上调用<tt class="docutils literal"><span class="pre">using()</span></tt>就可以让<tt class="docutils literal"><span class="pre">QuerySet</span></tt>使用一个指定的数据库。</font></p>
<p><font id="91"><tt class="docutils literal"><span class="pre">using()</span></tt> 接收单个参数：你的查询想要运行的数据库的别名。</font><font id="92">例如：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="c"># This will run on the 'default' database.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># So will this.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">'default'</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c"># This will run on the 'other' database.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">'other'</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="s-selecting-a-database-for-save">
<span id="selecting-a-database-for-save"></span><h3><font id="171">为<tt class="docutils literal"><span class="pre">save()</span></tt> 选择一个数据库</font><a class="headerlink" href="multi-db.html#selecting-a-database-for-save" title="Permalink to this headline">¶</a></h3>
<p><font id="93">对<tt class="docutils literal"><span class="pre">Model.save()</span></tt>使用<tt class="docutils literal"><span class="pre">using</span></tt> 关键字来指定数据应该保存在哪个数据库。</font></p>
<p><font id="94">例如，若要保存一个对象到<tt class="docutils literal"><span class="pre">legacy_users</span></tt> 数据库，你应该使用：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">my_object</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'legacy_users'</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="95">如果你不指定<tt class="docutils literal"><span class="pre">using</span></tt>，<tt class="docutils literal"><span class="pre">save()</span></tt>方法将保存到路由分配的默认数据库中。</font></p>
<div class="section" id="s-moving-an-object-from-one-database-to-another">
<span id="moving-an-object-from-one-database-to-another"></span><h4><font id="183">将对象从一个数据库移动到另一个数据库</font><a class="headerlink" href="multi-db.html#moving-an-object-from-one-database-to-another" title="Permalink to this headline">¶</a></h4>
<p><font id="96">如果你已经保存一个实例到一个数据库中，你可能很想使用<tt class="docutils literal"><span class="pre">save(using=...)</span></tt> 来迁移该实例到一个新的数据库中。</font><font id="97">然而，如果你不使用正确的步骤，这可能导致意外的结果。</font></p>
<p><font id="98">考虑下面的例子：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Fred'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'first'</span><span class="p">)</span>  <span class="c"># (statement 1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'second'</span><span class="p">)</span> <span class="c"># (statement 2)</span>
</pre></div>
</div>
<p><font id="99">在statement 1中，一个新的<tt class="docutils literal"><span class="pre">Person</span></tt> 对象被保存到 <tt class="docutils literal"><span class="pre">first</span></tt> 数据库中。</font><font id="100">此时<tt class="docutils literal"><span class="pre">p</span></tt> 没有主键，所以Django 发出一个SQL <tt class="docutils literal"><span class="pre">INSERT</span></tt> 语句。</font><font id="101">这会创建一个主键，且Django 将此主键赋值给<tt class="docutils literal"><span class="pre">p</span></tt>。</font></p>
<p><font id="102">当保存在statement 2中发生时，<tt class="docutils literal"><span class="pre">p</span></tt>已经具有一个主键，Django 将尝试在新的数据库上使用该主键。</font><font id="103">如果该主键值在<tt class="docutils literal"><span class="pre">second</span></tt> 数据库中没有使用，那么你不会遇到问题 —— 该对象将被复制到新的数据库中。</font></p>
<p><font id="104">然而，如果<tt class="docutils literal"><span class="pre">p</span></tt> 的主键在<tt class="docutils literal"><span class="pre">second</span></tt>数据库上已经在使用<tt class="docutils literal"><span class="pre">second</span></tt> 数据库中的已经存在的对象将在<tt class="docutils literal"><span class="pre">p</span></tt>保存时被覆盖。</font></p>
<p><font id="105">你可以用两种方法避免这种情况。</font><font id="106">首先，你可以清除实例的主键。</font><font id="107">如果一个对象没有主键，Django 将把它当做一个新的对象，这将避免<tt class="docutils literal"><span class="pre">second</span></tt>数据库上数据的丢失：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Fred'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'first'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Clear the primary key.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'second'</span><span class="p">)</span> <span class="c"># Write a completely new object.</span>
</pre></div>
</div>
<p><font id="108">第二种方法是使用<tt class="docutils literal"><span class="pre">force_insert</span></tt> 选项来<tt class="docutils literal"><span class="pre">save()</span></tt>以确保Django 使用一个<tt class="docutils literal"><span class="pre">INSERT</span></tt> SQL：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Fred'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'first'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'second'</span><span class="p">,</span> <span class="n">force_insert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="109">这将确保名称为<tt class="docutils literal"><span class="pre">Fred</span></tt> 的Person在两个数据库上具有相同的主键。</font><font id="110">在你试图保存到<tt class="docutils literal"><span class="pre">second</span></tt>数据库，如果主键已经在使用，将会引抛出发一个错误。</font></p>
</div>
</div>
<div class="section" id="s-selecting-a-database-to-delete-from">
<span id="selecting-a-database-to-delete-from"></span><h3><font id="172">选择一个数据库用于删除表单</font><a class="headerlink" href="multi-db.html#selecting-a-database-to-delete-from" title="Permalink to this headline">¶</a></h3>
<p><font id="111">默认情况下，删除一个已存在对象的调用将在与获取对象时使用的相同数据库上执行：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">'legacy_users'</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'fred'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span> <span class="c"># will delete from the `legacy_users` database</span>
</pre></div>
</div>
<p><font id="112">要指定删除一个模型时使用的数据库，可以对<tt class="docutils literal"><span class="pre">Model.delete()</span></tt>方法使用<tt class="docutils literal"><span class="pre">using</span></tt> 关键字参数。</font><font id="113">这个参数的工作方式与<tt class="docutils literal"><span class="pre">save()</span></tt>的<tt class="docutils literal"><span class="pre">using</span></tt>关键字参数一样。</font></p>
<p><font id="114">例如，你正在从<tt class="docutils literal"><span class="pre">legacy_users</span></tt> 数据库到<tt class="docutils literal"><span class="pre">new_users</span></tt> 数据库迁移一个User ，你可以使用这些命令：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user_obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'new_users'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">'legacy_users'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="s-using-managers-with-multiple-databases">
<span id="using-managers-with-multiple-databases"></span><h3><font id="173">多个数据库上使用管理器</font><a class="headerlink" href="multi-db.html#using-managers-with-multiple-databases" title="Permalink to this headline">¶</a></h3>
<p><font id="115">在管理器上使用<tt class="docutils literal"><span class="pre">db_manager()</span></tt>方法来让管理器访问非默认的数据库。</font></p>
<p><font id="116">例如，你有一个自定义的管理器方法，它访问数据库时候用 ——<tt class="docutils literal"><span class="pre">User.objects.create_user()</span></tt>。</font><font id="117">因为<tt class="docutils literal"><span class="pre">create_user()</span></tt>是一个管理器方法，不是一个<tt class="docutils literal"><span class="pre">QuerySet</span></tt>方法，你不可以使用<tt class="docutils literal"><span class="pre">User.objects.using('new_users').create_user()</span></tt>。</font><font id="118">（<tt class="docutils literal"><span class="pre">create_user()</span></tt> 方法只能在<tt class="docutils literal"><span class="pre">User.objects</span></tt>上使用，而不能在从管理器得到的<tt class="docutils literal"><span class="pre">QuerySet</span></tt>上使用）。</font><font id="119">解决办法是使用<tt class="docutils literal"><span class="pre">db_manager()</span></tt>，像这样：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">'new_users'</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="120"><tt class="docutils literal"><span class="pre">db_manager()</span></tt> 返回一个绑定在你指定的数据上的一个管理器。</font></p>
<div class="section" id="s-using-get-queryset-with-multiple-databases">
<span id="using-get-queryset-with-multiple-databases"></span><h4><font id="184">多数据库上使用<tt class="docutils literal"><span class="pre">get_queryset()</span></tt></font><a class="headerlink" href="multi-db.html#using-get-queryset-with-multiple-databases" title="Permalink to this headline">¶</a></h4>
<p><font id="121">如果你正在覆盖你的管理器上的<tt class="docutils literal"><span class="pre">get_queryset()</span></tt>，请确保在其父类上调用方法（使用<tt class="docutils literal"><span class="pre">super()</span></tt>）或者正确处理管理器上的<tt class="docutils literal"><span class="pre">_db</span></tt>属性（一个包含将要使用的数据库名称的字符串）。</font></p>
<p><font id="122">例如，如果你想从<tt class="docutils literal"><span class="pre">get_queryset</span></tt> 方法返回一个自定义的 <tt class="docutils literal"><span class="pre">QuerySet</span></tt> 类，你可以这样做：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">CustomQuerySet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="s-exposing-multiple-databases-in-django-s-admin-interface">
<span id="exposing-multiple-databases-in-django-s-admin-interface"></span><h2><font id="223">Django 的管理站点中使用多数据库</font><a class="headerlink" href="multi-db.html#exposing-multiple-databases-in-django-s-admin-interface" title="Permalink to this headline">¶</a></h2>
<p><font id="123">Django 的管理站点没有对多数据库的任何显式的支持。</font><font id="124">如果你给数据库上某个模型提供的管理站点不想通过你的路由链指定，你将需要编写自定义的<a class="reference internal" href="../../ref/contrib/admin/index.html#django.contrib.admin.ModelAdmin" title="django.contrib.admin.ModelAdmin"><tt class="xref py py-class docutils literal"><span class="pre">ModelAdmin</span></tt></a>类用来将管理站点导向一个特殊的数据库。</font></p>
<p><font id="125"><tt class="docutils literal"><span class="pre">ModelAdmin</span></tt> 对象具有5个方法，它们需要定制以支持多数据库：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MultiDBModelAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="c"># A handy constant for the name of the alternate database.</span>
    <span class="n">using</span> <span class="o">=</span> <span class="s">'other'</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="c"># Tell Django to save objects to the 'other' database.</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c"># Tell Django to delete objects from the 'other' database</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c"># Tell Django to look for objects on the 'other' database.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBModelAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formfield_for_foreignkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Tell Django to populate ForeignKey widgets using a query</span>
        <span class="c"># on the 'other' database.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBModelAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_foreignkey</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formfield_for_manytomany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Tell Django to populate ManyToMany widgets using a query</span>
        <span class="c"># on the 'other' database.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBModelAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_manytomany</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="126">这里提供的实现实现了一个多数据库策略，其中一个给定类型的所有对象都将保存在一个特定的数据库上（例如，所有的<tt class="docutils literal"><span class="pre">User</span></tt>保存在<tt class="docutils literal"><span class="pre">other</span></tt> 数据库中）。</font><font id="127">如果你的多数据库的用法更加复杂，你的<tt class="docutils literal"><span class="pre">ModelAdmin</span></tt>将需要反映相应的策略。</font></p>
<p><font id="128">Inlines 可以用相似的方式处理。</font><font id="129">它们需要3个自定义的方法：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MultiDBTabularInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">using</span> <span class="o">=</span> <span class="s">'other'</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c"># Tell Django to look for inline objects on the 'other' database.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBTabularInline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formfield_for_foreignkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Tell Django to populate ForeignKey widgets using a query</span>
        <span class="c"># on the 'other' database.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBTabularInline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_foreignkey</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formfield_for_manytomany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Tell Django to populate ManyToMany widgets using a query</span>
        <span class="c"># on the 'other' database.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBTabularInline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_manytomany</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="130">一旦你写好你的模型管理站点的定义，它们就可以使用任何<tt class="docutils literal"><span class="pre">Admin</span></tt>实例来注册：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="c"># Specialize the multi-db admin objects for use with specific models.</span>
<span class="k">class</span> <span class="nc">BookInline</span><span class="p">(</span><span class="n">MultiDBTabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Book</span>

<span class="k">class</span> <span class="nc">PublisherAdmin</span><span class="p">(</span><span class="n">MultiDBModelAdmin</span><span class="p">):</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">BookInline</span><span class="p">]</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="n">MultiDBModelAdmin</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">PublisherAdmin</span><span class="p">)</span>

<span class="n">othersite</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">AdminSite</span><span class="p">(</span><span class="s">'othersite'</span><span class="p">)</span>
<span class="n">othersite</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">MultiDBModelAdmin</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="131">这个例子建立两个管理站点。</font><font id="132">在第一个站点上，<tt class="docutils literal"><span class="pre">Author</span></tt> 和 <tt class="docutils literal"><span class="pre">Publisher</span></tt> 对象被暴露出来；</font><font id="133"><tt class="docutils literal"><span class="pre">Publisher</span></tt> 对象具有一个表格的内联，显示该出版社出版的书籍。</font><font id="134">第二个站点只暴露Publishers，而没有内联。</font></p>
</div>
<div class="section" id="s-using-raw-cursors-with-multiple-databases">
<span id="using-raw-cursors-with-multiple-databases"></span><h2><font id="164">多数据库上使用原始游标</font><a class="headerlink" href="multi-db.html#using-raw-cursors-with-multiple-databases" title="Permalink to this headline">¶</a></h2>
<p><font id="135">如果你正在使用多个数据库，你可以使用<tt class="docutils literal"><span class="pre">django.db.connections</span></tt>来获取特定数据库的连接（和游标）：</font><font id="136"><tt class="docutils literal"><span class="pre">django.db.connections</span></tt>是一个类字典对象，它允许你使用别名来获取一个特定的连接：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connections</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="s">'my_db_alias'</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="s-limitations-of-multiple-databases">
<span id="limitations-of-multiple-databases"></span><h2><font id="165">多数据库的局限</font><a class="headerlink" href="multi-db.html#limitations-of-multiple-databases" title="Permalink to this headline">¶</a></h2>
<div class="section" id="s-cross-database-relations">
<span id="s-no-cross-database-relations"></span><span id="cross-database-relations"></span><span id="no-cross-database-relations"></span><h3><font id="174">跨数据库关联</font><a class="headerlink" href="multi-db.html#cross-database-relations" title="Permalink to this headline">¶</a></h3>
<p><font id="137">Django 目前不提供跨多个数据库的外键或多对多关系的支持。</font><font id="138">如果你使用一个路由来路由分离到不同的数据库上，这些模型定义的任何外键和多对多关联必须在单个数据库的内部。</font></p>
<p><font id="139">这是因为引用完整性的原因。</font><font id="140">为了保持两个对象之间的关联，Django 需要知道关联对象的主键是合法的。</font><font id="141">如果主键存储在另外一个数据库上，判断一个主键的合法性不是很容易。</font></p>
<p><font id="142">如果你正在使用Postgres、Oracle或者MySQ 的InnoDB，这是数据库完整性级别的强制要求 —— 数据库级别的主键约束防止创建不能验证合法性的关联。</font></p>
<p><font id="143">然而，如果你正在使用SQLite 或MySQL的MyISAM 表，则没有强制性的引用完整性；</font><font id="144">结果是你可以‘伪造’跨数据库的外键。</font><font id="145">但是Django 官方不支持这种配置。</font></p>
</div>
<div class="section" id="s-behavior-of-contrib-apps">
<span id="s-contrib-app-multiple-databases"></span><span id="behavior-of-contrib-apps"></span><span id="contrib-app-multiple-databases"></span><h3><font id="175">Contrib 应用的行为</font><a class="headerlink" href="multi-db.html#behavior-of-contrib-apps" title="Permalink to this headline">¶</a></h3>
<p><font id="146">有几个Contrib 应用包含模型，其中一些应用相互依赖。</font><font id="147">因为跨数据库的关联是不可能的，这对你如何在数据库之间划分这些模型带来一些限制：</font></p>
<ul class="simple">
<li><font id="185"><tt class="docutils literal"><span class="pre">contenttypes.ContentType</span></tt>、<tt class="docutils literal"><span class="pre">sessions.Session</span></tt>和<tt class="docutils literal"><span class="pre">sites.Site</span></tt> 可以存储在分开存储在不同的数据库中，只要给出合适的路由</font></li>
<li><font id="189"><tt class="docutils literal"><span class="pre">auth</span></tt>模型 —— <tt class="docutils literal"><span class="pre">User</span></tt>、<tt class="docutils literal"><span class="pre">Group</span></tt>和<tt class="docutils literal"><span class="pre">Permission</span></tt> —— 关联在一起并与<tt class="docutils literal"><span class="pre">ContentType</span></tt>关联，所以它们必须与<tt class="docutils literal"><span class="pre">ContentType</span></tt>存储在相同的数据库中。</font></li>
<li><font id="190"><tt class="docutils literal"><span class="pre">admin</span></tt>依赖<tt class="docutils literal"><span class="pre">auth</span></tt>，所以它们的模型必须与<tt class="docutils literal"><span class="pre">auth</span></tt>在同一个数据库中。</font></li>
<li><font id="191"><tt class="docutils literal"><span class="pre">flatpages</span></tt>和<tt class="docutils literal"><span class="pre">redirects</span></tt>依赖<tt class="docutils literal"><span class="pre">sites</span></tt>，所以它们必须与<tt class="docutils literal"><span class="pre">sites</span></tt>在同一个数据库中。</font></li>
</ul>
<p><font id="148">另外，一些对象在<a class="reference internal" href="../../ref/django-admin.html#django-admin-migrate"><tt class="xref std std-djadmin docutils literal"><span class="pre">migrate</span></tt></a>在数据库中创建一张表后自动创建：</font></p>
<ul class="simple">
<li><font id="192">一个默认的<tt class="docutils literal"><span class="pre">Site</span></tt>，</font></li>
<li><font id="193">为每个模型创建一个<tt class="docutils literal"><span class="pre">ContentType</span></tt>（包括没有存储在同一个数据库中的模型），</font></li>
<li><font id="194">为每个模型创建3个<tt class="docutils literal"><span class="pre">Permission</span></tt> （包括不是存储在同一个数据库中的模型）。</font></li>
</ul>
<p><font id="149">对于常见的多数据库架构，将这些对象放在多个数据库中没有什么用处。</font><font id="150">常见的数据库架构包括primary/replica 和连接到外部的数据库。</font><font id="151">因此，建议写一个<a class="reference internal" href="multi-db.html#topics-db-multi-db-routing"><em>数据库路由</em></a>，它只允许同步这3个模型到一个数据中。</font><font id="152">对于不需要将表放在多个数据库中的Contrib 应用和第三方应用，可以使用同样的方法。</font></p>
<div class="admonition warning">
<p class="first admonition-title"><font id="153">警告</font></p>
<p class="last"><font id="154">如果你将Content Types 同步到多个数据库中，注意它们的主键在数据库之间可能不一致。</font><font id="155">这可能导致数据损坏或数据丢失。</font></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="yui-b" id="sidebar">
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<h3><font id="176">目录</font></h3>
<ul>
<li><a class="reference internal" href="multi-db.html#"><font id="195">多数据库</font></a><ul>
<li><a class="reference internal" href="multi-db.html#defining-your-databases"><font id="196">定义你的数据库</font></a></li>
<li><a class="reference internal" href="multi-db.html#synchronizing-your-databases"><font id="197">同步你的数据库</font></a><ul>
<li><a class="reference internal" href="multi-db.html#using-other-management-commands"><font id="198">使用其它管理命令</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="multi-db.html#automatic-database-routing"><font id="199">数据库自动路由</font></a><ul>
<li><a class="reference internal" href="multi-db.html#database-routers"><font id="200">数据库路由</font></a><ul>
<li><a class="reference internal" href="multi-db.html#hints"><font id="201">Hints</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="multi-db.html#using-routers"><font id="202">使用路由</font></a></li>
<li><a class="reference internal" href="multi-db.html#an-example"><font id="203">一个例子</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="multi-db.html#manually-selecting-a-database"><font id="204">人工选择一个数据库</font></a><ul>
<li><a class="reference internal" href="multi-db.html#manually-selecting-a-database-for-a-queryset"><font id="205">为<tt class="docutils literal"><span class="pre">QuerySet</span></tt>人工选择一个数据库</font></a></li>
<li><a class="reference internal" href="multi-db.html#selecting-a-database-for-save"><font id="206">为<tt class="docutils literal"><span class="pre">save()</span></tt>选择一个数据库</font></a><ul>
<li><a class="reference internal" href="multi-db.html#moving-an-object-from-one-database-to-another"><font id="207">将对象从一个数据库移动到另一个数据库</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="multi-db.html#selecting-a-database-to-delete-from"><font id="208">选择一个删除的数据库</font></a></li>
<li><a class="reference internal" href="multi-db.html#using-managers-with-multiple-databases"><font id="209">多数据库上使用管理器</font></a><ul>
<li><a class="reference internal" href="multi-db.html#using-get-queryset-with-multiple-databases"><font id="210">多数据库上使用<tt class="docutils literal"><span class="pre">get_queryset()</span></tt></font></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="multi-db.html#exposing-multiple-databases-in-django-s-admin-interface"><font id="222">Django 的管理站点中使用多数据库</font></a></li>
<li><a class="reference internal" href="multi-db.html#using-raw-cursors-with-multiple-databases"><font id="211">在多个数据库上使用原始的游标</font></a></li>
<li><a class="reference internal" href="multi-db.html#limitations-of-multiple-databases"><font id="212">多数据库的局限</font></a><ul>
<li><a class="reference internal" href="multi-db.html#cross-database-relations"><font id="213">跨数据库关联</font></a></li>
<li><a class="reference internal" href="multi-db.html#behavior-of-contrib-apps"><font id="214">Contrib 应用的行为</font></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><font id="177">浏览</font></h3>
<ul>
<li><font id="215">上一页：<a href="transactions.html">数据库事务</a></font></li>
<li><font id="216">下一页：<a href="tablespaces.html">表空间</a></font></li>
</ul>
<h3><font id="178">你在这里：</font></h3>
<ul>
<li>
<a href="../../index.html"><font id="217">Django 1.8.2 文档</font></a>
<ul><li><a href="../index.html"><font id="218">使用Django</font></a>
<ul><li><a href="index.html"><font id="219">模型和数据库</font></a>
<ul><li><font id="220">多数据库</font></li></ul>
</li></ul></li></ul>
</li>
</ul>
<h3><font id="179">本页：</font></h3>
<ul class="this-page-menu">
<li><a href="http://python.usyiyi.cn/django/_sources/topics/db/multi-db.txt" rel="nofollow"><font id="221">Show Source</font></a></li>
</ul>
<div id="searchbox" style="display: none">
<h3><font id="180">Quick search</font></h3>
<form action="http://python.usyiyi.cn/django/search.html" class="search" method="get">
<input name="q" type="text"/>
<input type="submit" value="Go"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
<p class="searchtip" style="font-size: 90%"><font id="156"> Enter search terms or a module, class or function name. </font></p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<h3><font id="181">最后更新：</font></h3>
<p class="topless"><font id="157">May 13, 2015</font></p>
</div>
</div>
<div id="ft">
<div class="nav">
    « <a href="transactions.html" title="Database transactions">previous</a>
     |
    <a accesskey="U" href="../index.html" title="Using Django">up</a>
   |
    <a href="tablespaces.html" title="Tablespaces">next</a> »</div>
</div>
</div>
<div class="clearer"></div>
</div>
<div id="disqus_thread"></div><br>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'djangocn'; // required: replace example with your forum shortname
    var disqus_identifier = '/django/topics/db/multi-db';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<link href="http://python.usyiyi.cn/django/_static/ms_translator.css" rel="stylesheet" type="text/css"/>
<script src="http://python.usyiyi.cn/django/_static/ms_translator.js" type="text/javascript"></script>
<script src="http://python.usyiyi.cn/django/_static/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
<div id="MicrosoftTranslator" style="display:none; position: absolute; z-index: 2147483647; margin: 0px; border: 2px solid rgb(210, 210, 210); padding: 0px; color: rgb(0, 0, 0); background-color: rgb(230, 230, 230); font-family: Arial,Helvetica,Sans-Serif; font-style: normal; font-variant: normal; font-weight: normal; font-size: 12px; line-height: normal; direction: ltr; text-align: left; left: 274px; top: 2048.03px; min-width: 400px;">
    <div id="MSTCClose" style="float: right;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/tooltip_close.gif">
      </a>
    </div>
    
    <div id="MSTCPopDown" style="float: right;" style="display: none;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/popdown.gif">
      </a>
    </div>
    <div id="MSTCPopUP" style="float: right;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/popup.gif">
      </a>
    </div>
    
    <div id="MSTCTitle" style="margin: 4px 4px 8px; font-weight: bold;">原文
    </div>
    
    <div style="direction: ltr; text-align: left;">
      <span id="MSTCOrigion" style="display: inline-block; margin: 0px 4px 4px;"> </span>
    </div>
    
    <div id="MicrosoftTranslatorCommunity" class="MSTCltr">
      <div id="MSTCContent">
        <a id="MSTCExpandLink">
          <span id="MSTCImprove">改进翻译</span>
          <span id="MSTCSuggest">最小化</span>
          <img src="http://python.usyiyi.cn/django/_static/ctftoggledown.gif" id="MSTCToggleDown">
          <img src="http://python.usyiyi.cn/django/_static/ctftoggleup.gif" id="MSTCToggleUp">
        </a>
        <div id="MSTCRootPanel">
          <span id="MSTCLoading" style="display: none;">正在加载...</span>
          <div style="display: none;" id="MSTCTransPanelError">
            <div class="MSTCTableRow">
              <div class="MSTCTransPanelExc MSTCTableCell">
                <img style="border-width:0px;" src="http://python.usyiyi.cn/django/_static/error_exclamation.gif" id="ExclamationImage">
              </div>
              <div class="MSTCTableCell">
                <span id="MSTCTransPanelErrorMsg"></span>
              </div>
            </div>
            <div class="MSTCTableRow">
              <div class="MSTCTableCell"></div>
              <div class="MSTCTableCell MSTCFlipHoriz">
                <input type="image" style="border-width:0px;" src="http://python.usyiyi.cn/django/_static/error_OK.gif" class="MSTCErrorButtons" id="MSTCOKImgBtn" name="MSTCOKImgBtn">
              </div>
            </div>
          </div>
          
          <div id="MSTCTransPanel">
          </div>
          
          <div id="MSTCPrevNextPanel">
            <a id="MSTCPrevLink" style='border-right-width: 1px;border-right-style: solid;padding-right: 5px;'>
              <span>上一页</span>
            </a>
            <a style='color: black; border-right-width: 1px;border-right-style: solid;padding-right: 5px;'>
              <span>第</span>
              <span id="MSTCPage"></span>
              <span>页</span>
            </a>
            <a id="MSTCNextLink" style='padding-left: 5px;'>
              <span>下一页</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>