<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>优化数据库访问 — Django 1.8.2 中文文档</title>
<link href="../../_static/default.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.8.2.dev20150513143415',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<link href="../../index.html" rel="top" title="Django 1.8.2.dev20150513143415 documentation"/>
<link href="index.html" rel="up" title="Models and databases"/>
<link href="examples/index.html" rel="next" title="Examples of model relationship API usage"/>
<link href="tablespaces.html" rel="prev" title="Tablespaces"/>
<script src="http://python.usyiyi.cn/django/templatebuiltins.js" type="text/javascript"></script>
<script type="text/javascript">
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='http://python.usyiyi.cn/django/topics/db/&quot;&#32;+&#32;base&#32;+&#32;&quot;#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='http://python.usyiyi.cn/django/topics/db/&quot;&#32;+&#32;base&#32;+&#32;&quot;#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);
</script>
</head>
<body>
<div class="document">
<div class="yui-t6" id="custom-doc">
<div id="hd">
<h1><font id="87">Django 1.8.2 文档</font></h1>
<div id="global-nav">
<a href="../../index.html" title="Home page">Home</a>  |
        <a href="../../contents.html" title="Table of contents">Table of contents</a>  |
        <a href="../../genindex.html" title="Global index">Index</a>  |
        <a href="../../py-modindex.html" title="Module index">Modules</a>
</div>
<div class="nav">
    « <a href="tablespaces.html" title="Tablespaces">previous</a>
     |
    <a accesskey="U" href="../index.html" title="Using Django">up</a>
   |
    <a href="examples/index.html" title="Examples of model relationship API usage">next</a> »</div>
</div>
<div id="bd">
<div id="yui-main">
<div class="yui-b">
<div class="yui-g" id="topics-db-optimization">
<div class="section" id="s-database-access-optimization">
<span id="database-access-optimization"></span><h1><font id="88">数据库访问优化</font><a class="headerlink" href="optimization.html#database-access-optimization" title="Permalink to this headline">¶</a></h1>
<p><font id="1">Django的数据库层提供了很多方法来帮助开发者充分的利用他们的数据库。</font><font id="2">这篇文档收集了相关文档的一些链接，添加了大量提示，并且按照优化数据库使用的步骤的概要来组织。</font></p>
<div class="section" id="s-profile-first">
<span id="profile-first"></span><h2><font id="89">性能优先</font><a class="headerlink" href="optimization.html#profile-first" title="Permalink to this headline">¶</a></h2>
<p><font id="3">作为通用的编程实践，性能的重要性不用多说。</font><font id="4">弄清楚<a class="reference internal" href="http://python.usyiyi.cn/django/faq/models.html#faq-see-raw-sql-queries"><em>你在执行什么查询以及你的开销花在哪里</em></a>。</font><font id="5">你也可能想使用外部的项目，像<a class="reference external" href="https://github.com/django-debug-toolbar/django-debug-toolbar/">django-debug-toolbar</a>，或者直接监控数据库的工具。</font></p>
<p><font id="6">记住你可以优化速度、内存占用，甚至二者一起，这取决于你的需求。</font><font id="7">一些针对其中一个的优化会对另一个不利，但有时会对二者都有帮助。</font><font id="8">另外，数据库进程做的工作，可能和你在Python代码中做的相同工作不具有相同的开销。</font><font id="9">决定你的优先级是什么，是你自己的事情，你必须要权衡利弊，按需使用它们，因为这取决于你的应用和服务器。</font></p>
<p><font id="10">对于下面提到的任何事情，要记住在任何修改后验证一下，确保修改是有利的，并且足够有利，能超过你代码中可读性的下降。</font><font id="11">下面的<strong>所有</strong>建议都带有警告，在你的环境中大体原则可能并不适用，或者会起到相反的效果。</font></p>
</div>
<div class="section" id="s-use-standard-db-optimization-techniques">
<span id="use-standard-db-optimization-techniques"></span><h2><font id="90">使用标准数据库优化技巧</font><a class="headerlink" href="optimization.html#use-standard-db-optimization-techniques" title="Permalink to this headline">¶</a></h2>
<p><font id="12">...包括：</font></p>
<ul class="simple">
<li><font id="115"><a class="reference external" href="http://en.wikipedia.org/wiki/Database_index">索引。</a></font><font id="116">在你决定哪些索引应该添加&nbsp;<em>之后</em>，这一条具有最高优先级。</font><font id="117">使用<a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.db_index" title="django.db.models.Field.db_index"><tt class="xref py py-attr docutils literal"><span class="pre">Field.db_index</span></tt></a>或者<a class="reference internal" href="../../ref/models/options.html#django.db.models.Options.index_together" title="django.db.models.Options.index_together"><tt class="xref py py-attr docutils literal"><span class="pre">Meta.index_together</span></tt></a>在Django中添加它们。</font><font id="118">考虑在你经常使用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><tt class="xref py py-meth docutils literal"><span class="pre">filter()</span></tt></a>、<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.exclude" title="django.db.models.query.QuerySet.exclude"><tt class="xref py py-meth docutils literal"><span class="pre">exclude()</span></tt></a>、<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><tt class="xref py py-meth docutils literal"><span class="pre">order_by()</span></tt></a>和其它方法查询的字段上面添加索引，因为索引有助于加速查找。</font><font id="119">注意，设计最好的索引方案是一个复杂的、数据库相关的话题，它取决于你应用的细节。</font><font id="120">持有索引的副作用可能会超过查询速度上的任何收益。</font></li>
</ul>
<ul class="simple">
<li><font id="121">合理使用字段类型。</font></li>
</ul>
<p><font id="13">我们假设你已经完成了上面这些显而易见的事情。</font><font id="14">这篇文档剩下的部分，着重于讲解如何以不做无用功的方式使用Django。</font><font id="15">这篇文档也没有强调用在开销大的操作上其它的优化技巧，像<a class="reference internal" href="../cache.html"><em>general purpose caching</em></a>。</font></p>
</div>
<div class="section" id="s-understand-querysets">
<span id="understand-querysets"></span><h2><font id="91">理解查询集</font><a class="headerlink" href="optimization.html#understand-querysets" title="Permalink to this headline">¶</a></h2>
<p><font id="16">理解<a class="reference internal" href="../../ref/models/querysets.html"><em>查询集(QuerySets)</em></a> 是通过简单的代码获取较好性能至关重要的一步。</font><font id="17">特别是：</font></p>
<div class="section" id="s-understand-queryset-evaluation">
<span id="understand-queryset-evaluation"></span><h3><font id="96">理解查询集计算</font><a class="headerlink" href="optimization.html#understand-queryset-evaluation" title="Permalink to this headline">¶</a></h3>
<p><font id="18">要避免性能问题，理解以下几点非常重要：</font></p>
<ul class="simple">
<li><font id="122"><a class="reference internal" href="queries.html#querysets-are-lazy"><em>QuerySets是延迟的</em></a>。</font></li>
<li><font id="123">什么时候<a class="reference internal" href="../../ref/models/querysets.html#when-querysets-are-evaluated"><em>它们被计算出来</em></a>。</font></li>
<li><font id="124"><a class="reference internal" href="queries.html#caching-and-querysets"><em>数据在内存中如何存储</em></a>。</font></li>
</ul>
</div>
<div class="section" id="s-understand-cached-attributes">
<span id="understand-cached-attributes"></span><h3><font id="97">理解缓存属性</font><a class="headerlink" href="optimization.html#understand-cached-attributes" title="Permalink to this headline">¶</a></h3>
<p><font id="19">和整个<tt class="docutils literal"><span class="pre">QuerySet</span></tt>的缓存相同，ORM对象的属性的结果中也存在缓存。</font><font id="20">通常来说，不可调用的属性会被缓存。</font><font id="21">例如下面的<a class="reference internal" href="queries.html#queryset-model-example"><em>博客模型示例</em></a>：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">blog</span>   <span class="c"># Blog object is retrieved at this point</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">blog</span>   <span class="c"># cached version, no DB access</span>
</pre></div>
</div>
<p><font id="22">但是通常来讲，可调用的属性每一次都会访问数据库。</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>   <span class="c"># query performed</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>   <span class="c"># query performed again</span>
</pre></div>
</div>
<p><font id="23">要小心当你阅读模板代码的时候 —— 模板系统不允许使用圆括号，但是会自动调用callable对象，会隐藏上述区别。</font></p>
<p><font id="24">要小心使用你自定义的属性 —— 实现所需的缓存取决于你，例如使用<a class="reference internal" href="http://python.usyiyi.cn/django/ref/utils.html#django.utils.functional.cached_property" title="django.utils.functional.cached_property"><tt class="xref py py-class docutils literal"><span class="pre">cached_property</span></tt></a>装饰符。</font></p>
</div>
<div class="section" id="s-use-the-with-template-tag">
<span id="use-the-with-template-tag"></span><h3><font id="98">使用<tt class="docutils literal"><span class="pre">with</span></tt>模板标签</font><a class="headerlink" href="optimization.html#use-the-with-template-tag" title="Permalink to this headline">¶</a></h3>
<p><font id="25">要利用<tt class="docutils literal"><span class="pre">QuerySet</span></tt>的缓存行为，你或许需要使用<a class="reference internal" href="../../ref/templates/builtins.html#std:templatetag-with"><tt class="xref std std-ttag docutils literal"><span class="pre">with</span></tt></a>模板标签。</font></p>
</div>
<div class="section" id="s-use-iterator">
<span id="use-iterator"></span><h3><font id="99">使用<tt class="docutils literal"><span class="pre">iterator()</span></tt></font><a class="headerlink" href="optimization.html#use-iterator" title="Permalink to this headline">¶</a></h3>
<p><font id="26">当你有很多对象时，<tt class="docutils literal"><span class="pre">QuerySet</span></tt>的缓存行为会占用大量的内存。</font><font id="27">这种情况下，采用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.iterator" title="django.db.models.query.QuerySet.iterator"><tt class="xref py py-meth docutils literal"><span class="pre">iterator()</span></tt></a>解决。</font></p>
</div>
</div>
<div class="section" id="s-do-database-work-in-the-database-rather-than-in-python">
<span id="do-database-work-in-the-database-rather-than-in-python"></span><h2><font id="92">在数据库中而不是Python中做数据库的工作</font><a class="headerlink" href="optimization.html#do-database-work-in-the-database-rather-than-in-python" title="Permalink to this headline">¶</a></h2>
<p><font id="28">比如：</font></p>
<ul class="simple">
<li><font id="125">在最基础的层面上，使用<a class="reference internal" href="../../ref/models/querysets.html#queryset-api"><em>过滤器和反向过滤器</em></a>对数据库进行过滤。</font></li>
<li><font id="126">使用<a class="reference internal" href="../../ref/models/expressions.html#django.db.models.F" title="django.db.models.F"><tt class="xref py py-class docutils literal"><span class="pre">F</span> <span class="pre">表达式</span></tt></a>在相同模型中基于其他字段进行过滤。</font></li>
<li><font id="127">使用<a class="reference internal" href="aggregation.html"><em>数据库中的注解和聚合</em></a>。</font></li>
</ul>
<p><font id="29">如果上面那些都不够用，你可以自己生成SQL语句：</font></p>
<div class="section" id="s-use-queryset-extra">
<span id="use-queryset-extra"></span><h3><font id="100">使用<tt class="docutils literal"><span class="pre">QuerySet.extra()</span></tt></font><a class="headerlink" href="optimization.html#use-queryset-extra" title="Permalink to this headline">¶</a></h3>
<p><font id="30">&nbsp;<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.extra" title="django.db.models.query.QuerySet.extra"><tt class="xref py py-meth docutils literal"><span class="pre">extra()</span></tt></a>是一个移植性更差，但是功能更强的方法，它允许一些SQL语句显式添加到查询中。</font><font id="31">如果这些还不够强大：</font></p>
</div>
<div class="section" id="s-use-raw-sql">
<span id="use-raw-sql"></span><h3><font id="101">使用原始的SQL</font><a class="headerlink" href="optimization.html#use-raw-sql" title="Permalink to this headline">¶</a></h3>
<p><font id="32">编写你自己的<a class="reference internal" href="sql.html"><em>自定义SQL语句</em></a>，来获取数据或者填充模型。</font><font id="33">使用<tt class="docutils literal"><span class="pre">django.db.connection.queries</span></tt>来了解Django为你编写了什么，以及从这里开始。</font></p>
</div>
</div>
<div class="section" id="s-retrieve-individual-objects-using-a-unique-indexed-column">
<span id="retrieve-individual-objects-using-a-unique-indexed-column"></span><h2><font id="93">用唯一的被或索引的列来检索独立对象</font><a class="headerlink" href="optimization.html#retrieve-individual-objects-using-a-unique-indexed-column" title="Permalink to this headline">¶</a></h2>
<p><font id="34">有两个原因在<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><tt class="xref py py-meth docutils literal"><span class="pre">get()</span></tt></a>中，用带有<a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.unique" title="django.db.models.Field.unique"><tt class="xref py py-attr docutils literal"><span class="pre">unique</span></tt></a>或者<a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.db_index" title="django.db.models.Field.db_index"><tt class="xref py py-attr docutils literal"><span class="pre">db_index</span></tt></a>的列检索独立对象。</font><font id="35">首先，由于查询经过了数据库的索引，所以会更快。</font><font id="36">其次，如果很多对象匹配查询，查询会更慢一些；</font><font id="37">列上的唯一性约束确保这种情况永远不会发生。</font></p>
<p><font id="38">所以，使用<a class="reference internal" href="queries.html#queryset-model-example"><em>博客模型的例子</em></a>：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="39">会快于：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s">"News Item Title"</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="40">因为<tt class="docutils literal"><span class="pre">id</span></tt>被数据库索引，而且是唯一的。</font></p>
<p><font id="41">下面这样做会十分缓慢：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">headline__startswith</span><span class="o">=</span><span class="s">"News"</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="42">首先，&nbsp;<tt class="docutils literal"><span class="pre">headline</span></tt>没有被索引，它会使查询变得很慢：</font></p>
<p><font id="43">其次，这次查找并不确保返回唯一的对象。</font><font id="44">如果查询匹配到多于一个对象，它会在数据库中遍历和检索所有这些对象。</font><font id="45">如果记录中返回了成百上千个对象，代价是非常大的。</font><font id="46">如果数据库运行在分布式服务器上，网络开销和延迟也是一大因素，代价会是它们的组合。
</font></p>
</div>
<div class="section" id="s-retrieve-everything-at-once-if-you-know-you-will-need-it">
<span id="retrieve-everything-at-once-if-you-know-you-will-need-it"></span><h2><font id="94">一次性检索你需要的任何东西</font><a class="headerlink" href="optimization.html#retrieve-everything-at-once-if-you-know-you-will-need-it" title="Permalink to this headline">¶</a></h2>
<p><font id="47">在不同的位置多次访问数据库，一次获取一个数据集，通常来说不如在一次查询中获取它们更高效。</font><font id="48">如果你在一个循环中执行查询，这尤其重要。有可能你会做很多次数据库查询，但只需要一次就够了。</font><font id="49">所以：</font></p>
<div class="section" id="s-use-queryset-select-related-and-prefetch-related">
<span id="use-queryset-select-related-and-prefetch-related"></span><h3><font id="102">使用<tt class="docutils literal"><span class="pre">QuerySet.select_related()</span></tt>和<tt class="docutils literal"><span class="pre">prefetch_related()</span></tt></font><a class="headerlink" href="optimization.html#use-queryset-select-related-and-prefetch-related" title="Permalink to this headline">¶</a></h3>
<p><font id="50">充分了解并使用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><tt class="xref py py-meth docutils literal"><span class="pre">select_related()</span></tt></a>和<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.prefetch_related" title="django.db.models.query.QuerySet.prefetch_related"><tt class="xref py py-meth docutils literal"><span class="pre">prefetch_related()</span></tt></a>：</font></p>
<ul class="simple">
<li><font id="128">在视图的代码中，</font></li>
<li><font id="129">以及在适当的<a class="reference internal" href="managers.html"><em>管理器和默认管理器</em></a>中。</font><font id="130">要意识到你的管理器什么时候被使用和不被使用；</font><font id="131">有时这很复杂，所以不要有任何假设。</font></li>
</ul>
</div>
</div>
<div class="section" id="s-don-t-retrieve-things-you-don-t-need">
<span id="don-t-retrieve-things-you-don-t-need"></span><h2>Don’t retrieve things you don’t need<a class="headerlink" href="optimization.html#don-t-retrieve-things-you-don-t-need" title="Permalink to this headline">¶</a></h2>
<div class="section" id="s-use-queryset-values-and-values-list">
<span id="use-queryset-values-and-values-list"></span><h3><font id="103">使用<tt class="docutils literal"><span class="pre">QuerySet.values()</span></tt>和<tt class="docutils literal"><span class="pre">values_list()</span></tt></font><a class="headerlink" href="optimization.html#use-queryset-values-and-values-list" title="Permalink to this headline">¶</a></h3>
<p><font id="51">当你仅仅想要一个带有值的<tt class="docutils literal"><span class="pre">字典</span></tt>或者<tt class="docutils literal"><span class="pre">列表</span></tt>，并不需要使用ORM模型对象时，可以适当使用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><tt class="xref py py-meth docutils literal"><span class="pre">values()</span></tt></a>。</font><font id="52">对于在模板代码中替换模型对象，这样会非常有用 —— 只要字典中带有的属性和模板中使用的一致，就没问题。</font></p>
</div>
<div class="section" id="s-use-queryset-defer-and-only">
<span id="use-queryset-defer-and-only"></span><h3><font id="104">使用<tt class="docutils literal"><span class="pre">QuerySet.defer()</span></tt>和<tt class="docutils literal"><span class="pre">only()</span></tt></font><a class="headerlink" href="optimization.html#use-queryset-defer-and-only" title="Permalink to this headline">¶</a></h3>
<p><font id="53">如果一些数据库的列你并不需要（或者大多数情况下并不需要），使用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><tt class="xref py py-meth docutils literal"><span class="pre">defer()</span></tt></a>和<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><tt class="xref py py-meth docutils literal"><span class="pre">only()</span></tt></a>来避免加载它们。</font><font id="54">注意如果你<em>确实</em>要用到它们，ORM会在另外的查询之中获取它们。如果你不能够合理地使用这些函数，不如不用。
</font></p>
<p><font id="55">另外，当建立起一个带有延迟字段的模型时，要意识到一些（小的、额外的）消耗会在Django内部产生。</font><font id="56">不要不分析数据库就盲目使用延迟字段，因为数据库必须从磁盘中读取大多数非text和VARCHAR数据，在结果中作为单独的一行，即使其中的列很少。
</font><font id="57"><tt class="docutils literal"><span class="pre">defer()</span></tt>和<tt class="docutils literal"><span class="pre">only()</span></tt>方法在你可以避免加载大量文本数据，或者可能要花大量时间处理而返回给Python的字段时，特别有帮助。</font><font id="58">像往常一样，应该先写出个大概，之后再优化。</font></p>
</div>
<div class="section" id="s-use-queryset-count">
<span id="use-queryset-count"></span><h3><font id="105">使用QuerySet.count()</font><a class="headerlink" href="optimization.html#use-queryset-count" title="Permalink to this headline">¶</a></h3>
<p><font id="59">...如果你想要获取大小，不要使用 <tt class="docutils literal"><span class="pre">len(queryset)</span></tt>。</font></p>
</div>
<div class="section" id="s-use-queryset-exists">
<span id="use-queryset-exists"></span><h3><font id="106">使用QuerySet.exists()</font><a class="headerlink" href="optimization.html#use-queryset-exists" title="Permalink to this headline">¶</a></h3>
<p><font id="60">...如果你想要知道是否存在至少一个结果，不要使用<tt class="docutils literal"><span class="pre">if</span> <span class="pre">queryset</span></tt>。</font></p>
<p><font id="61">但是：</font></p>
</div>
<div class="section" id="s-don-t-overuse-count-and-exists">
<span id="s-overuse-of-count-and-exists"></span><span id="don-t-overuse-count-and-exists"></span><span id="overuse-of-count-and-exists"></span><h3>Don’t overuse <tt class="docutils literal"><span class="pre">count()</span></tt> and <tt class="docutils literal"><span class="pre">exists()</span></tt><a class="headerlink" href="optimization.html#don-t-overuse-count-and-exists" title="Permalink to this headline">¶</a></h3>
<p><font id="62">如果你需要查询集中的其他数据，就把它加载出来。</font></p>
<p><font id="63">例如，假设Email模型有一个<tt class="docutils literal"><span class="pre">body</span></tt>属性，并且和User有多对多的关联，下面的的模板代码是最优的：</font></p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">if</span> <span class="nv">display_inbox</span> <span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">with</span> <span class="nv">emails</span><span class="o">=</span><span class="nv">user.emails.all</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">emails</span> <span class="cp">%}</span>
      <span class="nt">&lt;p&gt;</span>You have <span class="cp">{{</span> <span class="nv">emails</span><span class="o">|</span><span class="nf">length</span> <span class="cp">}}</span> email(s)<span class="nt">&lt;/p&gt;</span>
      <span class="cp">{%</span> <span class="k">for</span> <span class="nv">email</span> <span class="k">in</span> <span class="nv">emails</span> <span class="cp">%}</span>
        <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">email.body</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
      <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
      <span class="nt">&lt;p&gt;</span>No messages today.<span class="nt">&lt;/p&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">endwith</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</pre></div>
</div>
<p><font id="64">这是因为：</font></p>
<ol class="arabic simple">
<li><font id="132">因为查询集是延迟加载的，如果‘display_inbox’为False，不会查询数据库。</font></li>
<li><font id="133">使用<a class="reference internal" href="../../ref/templates/builtins.html#std:templatetag-with"><tt class="xref std std-ttag docutils literal"><span class="pre">with</span></tt></a>意味着我们为了以后的使用，把<tt class="docutils literal"><span class="pre">user.emails.all</span></tt>储存在一个变量中，允许它的缓存被复用。</font></li>
<li><font id="134"><tt class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">emails</span> <span class="pre">%}</span></tt>的那一行调用了<tt class="docutils literal"><span class="pre">QuerySet.__bool__()</span></tt>，它导致<tt class="docutils literal"><span class="pre">user.emails.all()</span></tt>查询在数据库上执行，并且至少在第一行以一个ORM对象的形式返回。</font><font id="135">如果没有任何结果，会返回False，反之为True。</font></li>
<li><font id="136"><tt class="docutils literal"><span class="pre">{{</span> <span class="pre">emails|length</span> <span class="pre">}}</span></tt>调用了<tt class="docutils literal"><span class="pre">QuerySet.__len__()</span></tt>方法，填充了缓存的剩余部分，而且并没有执行另一次查询。</font></li>
<li><font id="137"><a class="reference internal" href="../../ref/templates/builtins.html#std:templatetag-for"><tt class="xref std std-ttag docutils literal"><span class="pre">for</span></tt></a>循环的迭代器访问了已经缓存的数据。</font></li>
</ol>
<p><font id="65">总之，这段代码做了零或一次查询。</font><font id="66">唯一一个慎重的优化就是<a class="reference internal" href="../../ref/templates/builtins.html#std:templatetag-with"><tt class="xref std std-ttag docutils literal"><span class="pre">with</span></tt></a>标签的使用。</font><font id="67">在任何位置使用<tt class="docutils literal"><span class="pre">QuerySet.exists()</span></tt>或者<tt class="docutils literal"><span class="pre">QuerySet.count()</span></tt>都会导致额外的查询。</font></p>
</div>
<div class="section" id="s-use-queryset-update-and-delete">
<span id="use-queryset-update-and-delete"></span><h3><font id="107">使用<tt class="docutils literal"><span class="pre">QuerySet.update()</span></tt>和<tt class="docutils literal"><span class="pre">delete()</span></tt></font><a class="headerlink" href="optimization.html#use-queryset-update-and-delete" title="Permalink to this headline">¶</a></h3>
<p><font id="68">通过<a class="reference internal" href="queries.html#topics-db-queries-update"><em>QuerySet.update()</em></a>使用批量的SQL UPDATE语句，而不是获取大量对象，设置一些值再单独保存。</font><font id="69">与此相似，在可能的地方使用<a class="reference internal" href="queries.html#topics-db-queries-delete"><em>批量deletes</em></a>。</font></p>
<p><font id="70">但是要注意，这些批量的更新方法不会在单独的实例上面调用<tt class="docutils literal"><span class="pre">save()</span></tt>或者<tt class="docutils literal"><span class="pre">delete()</span></tt>方法，意思是任何你向这些方法添加的自定义行为都不会被执行，包括由普通数据库对象的<a class="reference internal" href="../../ref/signals.html"><em>信号</em></a>驱动的任何方法。</font></p>
</div>
<div class="section" id="s-use-foreign-key-values-directly">
<span id="use-foreign-key-values-directly"></span><h3><font id="108">直接使用外键的值</font><a class="headerlink" href="optimization.html#use-foreign-key-values-directly" title="Permalink to this headline">¶</a></h3>
<p><font id="71">如果你仅仅需要外键当中的一个值，要使用对象上你已经取得的外键的值，而不是获取整个关联对象再得到它的主键。</font><font id="72">例如，执行：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry</span><span class="o">.</span><span class="n">blog_id</span>
</pre></div>
</div>
<p><font id="73">而不是：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry</span><span class="o">.</span><span class="n">blog</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="section" id="s-don-t-order-results-if-you-don-t-care">
<span id="don-t-order-results-if-you-don-t-care"></span><h3>Don’t order results if you don’t care<a class="headerlink" href="optimization.html#don-t-order-results-if-you-don-t-care" title="Permalink to this headline">¶</a></h3>
<p><font id="74">排序并不是没有代价的；</font><font id="75">每个需要排序的字段都是数据库必须执行的操作。</font><font id="76">如果一个模型具有默认的顺序（<a class="reference internal" href="../../ref/models/options.html#django.db.models.Options.ordering" title="django.db.models.Options.ordering"><tt class="xref py py-attr docutils literal"><span class="pre">Meta.ordering</span></tt></a>），并且你并不需要它，通过在<tt class="docutils literal"><span class="pre">查询集</span></tt>上无参调用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><tt class="xref py py-meth docutils literal"><span class="pre">order_by()</span></tt></a> 来移除它。</font></p>
<p><font id="77">向你的数据库添加索引可能有助于提升排序性能。</font></p>
</div>
</div>
<div class="section" id="s-insert-in-bulk">
<span id="insert-in-bulk"></span><h2><font id="95">整体插入</font><a class="headerlink" href="optimization.html#insert-in-bulk" title="Permalink to this headline">¶</a></h2>
<p><font id="78">创建对象时，尽可能使用<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><tt class="xref py py-meth docutils literal"><span class="pre">bulk_create()</span></tt></a>来减少SQL查询的数量。</font><font id="79">例如：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">([</span>
    <span class="n">Entry</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s">"Python 3.0 Released"</span><span class="p">),</span>
    <span class="n">Entry</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s">"Python 3.1 Planned"</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p><font id="80">...更优于：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s">"Python 3.0 Released"</span><span class="p">)</span>
<span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s">"Python 3.1 Planned"</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="81">注意<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><tt class="xref py py-meth docutils literal"><span class="pre">该</span><span class="pre">方法</span><span class="pre">有</span>很多<span class="pre">注意事项</span></tt></a>，所以确保它适用于你的情况。</font></p>
<p><font id="82">这也可以用在<a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><tt class="xref py py-class docutils literal"><span class="pre">ManyToManyFields</span></tt></a>中，所以：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">my_friend</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="83">...更优于：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
<span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">my_friend</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="84">...其中<tt class="docutils literal"><span class="pre">Bands</span></tt>和<tt class="docutils literal"><span class="pre">Artists</span></tt>具有多对多关联。</font></p>
</div>
</div>
</div>
</div>
</div>
<div class="yui-b" id="sidebar">
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<h3><font id="109">Table Of Contents</font></h3>
<ul>
<li><a class="reference internal" href="optimization.html#"><font id="138">数据库访问优化</font></a><ul>
<li><a class="reference internal" href="optimization.html#profile-first"><font id="139">性能优先</font></a></li>
<li><a class="reference internal" href="optimization.html#use-standard-db-optimization-techniques"><font id="140">使用标准数据库优化技术</font></a></li>
<li><a class="reference internal" href="optimization.html#understand-querysets"><font id="141">理解 QuerySets</font></a><ul>
<li><a class="reference internal" href="optimization.html#understand-queryset-evaluation"><font id="142">理解查询评估</font></a></li>
<li><a class="reference internal" href="optimization.html#understand-cached-attributes"><font id="143">理解缓存属性</font></a></li>
<li><a class="reference internal" href="optimization.html#use-the-with-template-tag"><font id="144">使用<tt class="docutils literal"><span class="pre">with</span></tt> 模板标签</font></a></li>
<li><a class="reference internal" href="optimization.html#use-iterator"><font id="145">使用 <tt class="docutils literal"><span class="pre">iterator()</span></tt></font></a></li>
</ul>
</li>
<li><a class="reference internal" href="optimization.html#do-database-work-in-the-database-rather-than-in-python"><font id="146">Do database work in the database rather than in Python</font></a><ul>
<li><a class="reference internal" href="optimization.html#use-queryset-extra"><font id="147">Use <tt class="docutils literal"><span class="pre">QuerySet.extra()</span></tt></font></a></li>
<li><a class="reference internal" href="optimization.html#use-raw-sql"><font id="148">Use raw SQL</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="optimization.html#retrieve-individual-objects-using-a-unique-indexed-column"><font id="149">Retrieve individual objects using a unique, indexed column</font></a></li>
<li><a class="reference internal" href="optimization.html#retrieve-everything-at-once-if-you-know-you-will-need-it"><font id="150">Retrieve everything at once if you know you will need it</font></a><ul>
<li><a class="reference internal" href="optimization.html#use-queryset-select-related-and-prefetch-related"><font id="151">Use <tt class="docutils literal"><span class="pre">QuerySet.select_related()</span></tt> and <tt class="docutils literal"><span class="pre">prefetch_related()</span></tt></font></a></li>
</ul>
</li>
<li><a class="reference internal" href="optimization.html#don-t-retrieve-things-you-don-t-need">Don’t retrieve things you don’t need</a><ul>
<li><a class="reference internal" href="optimization.html#use-queryset-values-and-values-list"><font id="152">Use <tt class="docutils literal"><span class="pre">QuerySet.values()</span></tt> and <tt class="docutils literal"><span class="pre">values_list()</span></tt></font></a></li>
<li><a class="reference internal" href="optimization.html#use-queryset-defer-and-only"><font id="153">Use <tt class="docutils literal"><span class="pre">QuerySet.defer()</span></tt> and <tt class="docutils literal"><span class="pre">only()</span></tt></font></a></li>
<li><a class="reference internal" href="optimization.html#use-queryset-count"><font id="154">Use QuerySet.count()</font></a></li>
<li><a class="reference internal" href="optimization.html#use-queryset-exists"><font id="155">Use QuerySet.exists()</font></a></li>
<li><a class="reference internal" href="optimization.html#don-t-overuse-count-and-exists"><font id="156">Don’t overuse <tt class="docutils literal"><span class="pre">count()</span></tt> and <tt class="docutils literal"><span class="pre">exists()</span></tt></font></a></li>
<li><a class="reference internal" href="optimization.html#use-queryset-update-and-delete"><font id="157">Use <tt class="docutils literal"><span class="pre">QuerySet.update()</span></tt> and <tt class="docutils literal"><span class="pre">delete()</span></tt></font></a></li>
<li><a class="reference internal" href="optimization.html#use-foreign-key-values-directly"><font id="158">Use foreign key values directly</font></a></li>
<li><a class="reference internal" href="optimization.html#don-t-order-results-if-you-don-t-care">Don’t order results if you don’t care</a></li>
</ul>
</li>
<li><a class="reference internal" href="optimization.html#insert-in-bulk"><font id="159">Insert in bulk</font></a></li>
</ul>
</li>
</ul>
<h3><font id="110">Browse</font></h3>
<ul>
<li><font id="160">Prev: <a href="tablespaces.html">Tablespaces</a></font></li>
<li><font id="161">Next: <a href="examples/index.html">Examples of model relationship API usage</a></font></li>
</ul>
<h3><font id="111">You are here:</font></h3>
<ul>
<li>
<a href="../../index.html"><font id="162">Django 1.8.2.dev20150513143415 documentation</font></a>
<ul><li><a href="../index.html"><font id="163">Using Django</font></a>
<ul><li><a href="index.html"><font id="164">Models and databases</font></a>
<ul><li><font id="165">Database access optimization</font></li></ul>
</li></ul></li></ul>
</li>
</ul>
<h3><font id="112">This Page</font></h3>
<ul class="this-page-menu">
<li><a href="http://python.usyiyi.cn/django/_sources/topics/db/optimization.txt" rel="nofollow"><font id="166">Show Source</font></a></li>
</ul>
<div id="searchbox" style="display: none">
<h3><font id="113">Quick search</font></h3>
<form action="http://python.usyiyi.cn/django/search.html" class="search" method="get">
<input name="q" type="text"/>
<input type="submit" value="Go"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
<p class="searchtip" style="font-size: 90%"><font id="85"> Enter search terms or a module, class or function name. </font></p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<h3><font id="114">Last update:</font></h3>
<p class="topless"><font id="86">May 13, 2015</font></p>
</div>
</div>
<div id="ft">
<div class="nav">
    « <a href="tablespaces.html" title="Tablespaces">previous</a>
     |
    <a accesskey="U" href="../index.html" title="Using Django">up</a>
   |
    <a href="examples/index.html" title="Examples of model relationship API usage">next</a> »</div>
</div>
</div>
<div class="clearer"></div>
</div>
<div id="disqus_thread"></div><br>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'djangocn'; // required: replace example with your forum shortname
    var disqus_identifier = '/django/topics/db/optimization';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<link href="http://python.usyiyi.cn/django/_static/ms_translator.css" rel="stylesheet" type="text/css"/>
<script src="http://python.usyiyi.cn/django/_static/ms_translator.js" type="text/javascript"></script>
<script src="http://python.usyiyi.cn/django/_static/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
<div id="MicrosoftTranslator" style="display:none; position: absolute; z-index: 2147483647; margin: 0px; border: 2px solid rgb(210, 210, 210); padding: 0px; color: rgb(0, 0, 0); background-color: rgb(230, 230, 230); font-family: Arial,Helvetica,Sans-Serif; font-style: normal; font-variant: normal; font-weight: normal; font-size: 12px; line-height: normal; direction: ltr; text-align: left; left: 274px; top: 2048.03px; min-width: 400px;">
    <div id="MSTCClose" style="float: right;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/tooltip_close.gif">
      </a>
    </div>
    
    <div id="MSTCPopDown" style="float: right;" style="display: none;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/popdown.gif">
      </a>
    </div>
    <div id="MSTCPopUP" style="float: right;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/popup.gif">
      </a>
    </div>
    
    <div id="MSTCTitle" style="margin: 4px 4px 8px; font-weight: bold;">原文
    </div>
    
    <div style="direction: ltr; text-align: left;">
      <span id="MSTCOrigion" style="display: inline-block; margin: 0px 4px 4px;"> </span>
    </div>
    
    <div id="MicrosoftTranslatorCommunity" class="MSTCltr">
      <div id="MSTCContent">
        <a id="MSTCExpandLink">
          <span id="MSTCImprove">改进翻译</span>
          <span id="MSTCSuggest">最小化</span>
          <img src="http://python.usyiyi.cn/django/_static/ctftoggledown.gif" id="MSTCToggleDown">
          <img src="http://python.usyiyi.cn/django/_static/ctftoggleup.gif" id="MSTCToggleUp">
        </a>
        <div id="MSTCRootPanel">
          <span id="MSTCLoading" style="display: none;">正在加载...</span>
          <div style="display: none;" id="MSTCTransPanelError">
            <div class="MSTCTableRow">
              <div class="MSTCTransPanelExc MSTCTableCell">
                <img style="border-width:0px;" src="http://python.usyiyi.cn/django/_static/error_exclamation.gif" id="ExclamationImage">
              </div>
              <div class="MSTCTableCell">
                <span id="MSTCTransPanelErrorMsg"></span>
              </div>
            </div>
            <div class="MSTCTableRow">
              <div class="MSTCTableCell"></div>
              <div class="MSTCTableCell MSTCFlipHoriz">
                <input type="image" style="border-width:0px;" src="http://python.usyiyi.cn/django/_static/error_OK.gif" class="MSTCErrorButtons" id="MSTCOKImgBtn" name="MSTCOKImgBtn">
              </div>
            </div>
          </div>
          
          <div id="MSTCTransPanel">
          </div>
          
          <div id="MSTCPrevNextPanel">
            <a id="MSTCPrevLink" style='border-right-width: 1px;border-right-style: solid;padding-right: 5px;'>
              <span>上一页</span>
            </a>
            <a style='color: black; border-right-width: 1px;border-right-style: solid;padding-right: 5px;'>
              <span>第</span>
              <span id="MSTCPage"></span>
              <span>页</span>
            </a>
            <a id="MSTCNextLink" style='padding-left: 5px;'>
              <span>下一页</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>