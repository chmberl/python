<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Writing custom model fields — Django 1.8.2 中文文档</title>
<link href="../_static/default.css" rel="stylesheet" type="text/css"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.8.2.dev20150513143415',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
<script src="../_static/jquery.js" type="text/javascript"></script>
<script src="../_static/underscore.js" type="text/javascript"></script>
<script src="../_static/doctools.js" type="text/javascript"></script>
<link href="../index.html" rel="top" title="Django 1.8.2.dev20150513143415 documentation"/>
<link href="http://python.usyiyi.cn/django/howto/index.html" rel="up" title="“How-to” guides"/>
<link href="custom-lookups.html" rel="next" title="Custom Lookups"/>
<link href="custom-management-commands.html" rel="prev" title="Writing custom django-admin commands"/>
<script src="http://python.usyiyi.cn/django/templatebuiltins.js" type="text/javascript"></script>
<script type="text/javascript">
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='http://python.usyiyi.cn/django/howto/&quot;&#32;+&#32;base&#32;+&#32;&quot;#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='http://python.usyiyi.cn/django/howto/&quot;&#32;+&#32;base&#32;+&#32;&quot;#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);
</script>
</head>
<body>
<div class="document">
<div class="yui-t6" id="custom-doc">
<div id="hd">
<h1><font id="186">Django 1.8.2.dev20150513143415 documentation</font></h1>
<div id="global-nav">
<a href="../index.html" title="Home page">Home</a>  |
        <a href="../contents.html" title="Table of contents">Table of contents</a>  |
        <a href="../genindex.html" title="Global index">Index</a>  |
        <a href="../py-modindex.html" title="Module index">Modules</a>
</div>
<div class="nav">
    « <a href="custom-management-commands.html" title="Writing custom django-admin commands">previous</a>
     |
    <a accesskey="U" href="http://python.usyiyi.cn/django/howto/index.html" title="&amp;#8220;How-to&amp;#8221; guides">up</a>
   |
    <a href="custom-lookups.html" title="Custom Lookups">next</a> »</div>
</div>
<div id="bd">
<div id="yui-main">
<div class="yui-b">
<div class="yui-g" id="howto-custom-model-fields">
<div class="section" id="s-writing-custom-model-fields">
<span id="writing-custom-model-fields"></span><h1><font id="187">编写自定义 model 字段</font><a class="headerlink" href="custom-model-fields.html#writing-custom-model-fields" title="Permalink to this headline">¶</a></h1>
<div class="section" id="s-introduction">
<span id="introduction"></span><h2><font id="188">介绍</font><a class="headerlink" href="custom-model-fields.html#introduction" title="Permalink to this headline">¶</a></h2>
<p><font id="1"><a class="reference internal" href="../topics/db/models.html"><em>model 参考</em></a>文档已经介绍了如何使用 Django 的标准字段类；例如 <a class="reference internal" href="../ref/models/fields.html#django.db.models.CharField" title="django.db.models.CharField"><tt class="xref py py-class docutils literal"><span class="pre">CharField</span></tt></a>， <a class="reference internal" href="../ref/models/fields.html#django.db.models.DateField" title="django.db.models.DateField"><tt class="xref py py-class docutils literal"><span class="pre">DateField</span></tt></a>，等等。</font><font id="2">对于很多应用来说，这些类足够用了。 </font><font id="3">但是在某些情况下， 你所用的Django 版本不提供你想要的某些功能，或是你想使用的字段与 Django 自带字段不同。</font></p>
<p><font id="4">Django 内置的字段类型并不能覆盖所有可能遇到的数据库的列类型，仅仅是些普通的字段类型，例如<tt class="docutils literal"><span class="pre">VARCHAR</span></tt>和<tt class="docutils literal"><span class="pre">INTEGER</span></tt>。</font><font id="5">对于更多不常用的列类型，比如地理定位数据和诸如<a class="reference external" href="http://www.postgresql.org/docs/current/interactive/sql-createtype.html">PostgreSQL自定义类型</a>的自定义字段，你可以定义你自己的Django <tt class="docutils literal"><span class="pre">Field</span></tt>&nbsp; 子类。</font></p>
<p><font id="6">有两种实现方式：你可以编写一个复杂的 Python 对象，让它以某种方式将数据序列化，以适应某个数据库的列类型； </font><font id="7">或是你创建一个<tt class="docutils literal"><span class="pre">Field</span></tt>的子类，从而让你可以使用 model 中的对象。</font></p>
<div class="section" id="s-our-example-object">
<span id="our-example-object"></span><h3><font id="192">示例对象</font><a class="headerlink" href="custom-model-fields.html#our-example-object" title="Permalink to this headline">¶</a></h3>
<p><font id="8">创建自定义字段需要注意很多细节。 </font><font id="9">为了使这一章内容容易理解，自始至终我们都只使用这一个例子：包装一个 Python 对象来表示手中<a class="reference external" href="http://en.wikipedia.org/wiki/Contract_bridge">桥牌</a>的详细信息。</font><font id="10">不用担心，这个例子并不要求你会玩桥牌。 </font><font id="11">你只要知道 52 张牌被分配个四个玩家，按惯例，他们被称之为<em>北</em>, <em>东</em>, <em>南</em> 和 <em>西</em>。</font><font id="12">我们的类看起来就象这个样子：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Hand</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""A hand of cards (bridge style)"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">west</span><span class="p">):</span>
        <span class="c"># Input parameters are lists of cards ('Ah', '9s', etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">north</span> <span class="o">=</span> <span class="n">north</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">east</span> <span class="o">=</span> <span class="n">east</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">south</span> <span class="o">=</span> <span class="n">south</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">west</span> <span class="o">=</span> <span class="n">west</span>

    <span class="c"># ... (other possibly useful methods omitted) ...</span>
</pre></div>
</div>
<p><font id="13">这只是一个普通的 Python 类，并没有对 Django 做特别的设定。 </font><font id="14">在 model 中我们可以象下面这样使用 Hand (我们假设 model 中的 <tt class="docutils literal"><span class="pre">hand</span></tt> 属性是 <tt class="docutils literal"><span class="pre">Hand</span></tt> 类的一个实例)：</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">example</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">hand</span><span class="o">.</span><span class="n">north</span><span class="p">)</span>

<span class="n">new_hand</span> <span class="o">=</span> <span class="n">Hand</span><span class="p">(</span><span class="n">north</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">west</span><span class="p">)</span>
<span class="n">example</span><span class="o">.</span><span class="n">hand</span> <span class="o">=</span> <span class="n">new_hand</span>
<span class="n">example</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p><font id="15">我们可以象使用任何 Python 类一样，对 model 中的 <tt class="docutils literal"><span class="pre">hand</span></tt> 属性进行赋值和取值。</font><font id="16">利用这一点让 Django 知道如何处理保存和载入一个对象。</font></p>
<p><font id="17">为了在 model 中使用 <tt class="docutils literal"><span class="pre">Hand</span></tt> 类，我们<strong>不必</strong>为这个类做任何的改动。</font><font id="18">这是非常有用的，它表示着你可以很容易地为已存在的类编写模型支持，而不必改动类的原代码。</font></p>
<div class="admonition note">
<p class="first admonition-title"><font id="19">注意</font></p>
<p class="last"><font id="20">你可能只想利用自定义数据库列类型，将数据处理成模型中的标准 Python 类型， </font><font id="21">比如：字符串，浮点数等等。 </font><font id="22">这种情况与我们的 <tt class="docutils literal"><span class="pre">Hand</span></tt> 例子非常相似，我们随着文档的展开对两者的差异进行比较。</font></p>
</div>
</div>
</div>
<div class="section" id="s-background-theory">
<span id="background-theory"></span><h2><font id="189">后台原理</font><a class="headerlink" href="custom-model-fields.html#background-theory" title="Permalink to this headline">¶</a></h2>
<div class="section" id="s-database-storage">
<span id="database-storage"></span><h3><font id="193">数据库存储</font><a class="headerlink" href="custom-model-fields.html#database-storage" title="Permalink to this headline">¶</a></h3>
<p><font id="23">可以简单的认为 model 字段提供了一种方法来接受普通的 Python 对象，比如布尔值，<tt class="docutils literal"><span class="pre">datetime</span></tt>，或是象<tt class="docutils literal"><span class="pre">Hand</span></tt>这样更复杂的对象，然后在操作数据库时，对对象进行格式转换以适应数据库。（还有序列化也是同杰处理，但接下来我们会看到，一旦我们掌握了数据库这方面的转换，再对序列化做处理就游刃有余了）</font></p>
<p><font id="24">Fields in a model must somehow be converted to fit into an existing database column type. </font><font id="25">Different databases provide different sets of valid column types, but the rule is still the same: those are the only types you have to work with. </font><font id="26">Anything you want to store in the database must fit into one of those types.</font></p>
<p><font id="27">Normally, you’re either writing a Django field to match a particular database column type, or there’s a fairly straightforward way to convert your data to, say, a string.</font></p>
<p><font id="28">For our <tt class="docutils literal"><span class="pre">Hand</span></tt> example, we could convert the card data to a string of 104 characters by concatenating all the cards together in a pre-determined order – say, all the <em>north</em> cards first, then the <em>east</em>, <em>south</em> and <em>west</em> cards. </font><font id="29">So <tt class="docutils literal"><span class="pre">Hand</span></tt> objects can be saved to text or character columns in the database.</font></p>
</div>
<div class="section" id="s-what-does-a-field-class-do">
<span id="what-does-a-field-class-do"></span><h3><font id="194">What does a field class do?</font><a class="headerlink" href="custom-model-fields.html#what-does-a-field-class-do" title="Permalink to this headline">¶</a></h3>
<p><font id="30">All of Django’s fields (and when we say <em>fields</em> in this document, we always mean model fields and not <a class="reference internal" href="../ref/forms/fields.html"><em>form fields</em></a>) are subclasses of <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">django.db.models.Field</span></tt></a>. </font><font id="31">Most of the information that Django records about a field is common to all fields – name, help text, uniqueness and so forth. </font><font id="32">Storing all that information is handled by <tt class="docutils literal"><span class="pre">Field</span></tt>. </font><font id="33">We’ll get into the precise details of what <tt class="docutils literal"><span class="pre">Field</span></tt> can do later on; </font><font id="34">for now, suffice it to say that everything descends from <tt class="docutils literal"><span class="pre">Field</span></tt> and then customizes key pieces of the class behavior.</font></p>
<p><font id="35">It’s important to realize that a Django field class is not what is stored in your model attributes. </font><font id="36">The model attributes contain normal Python objects. </font><font id="37">The field classes you define in a model are actually stored in the <tt class="docutils literal"><span class="pre">Meta</span></tt> class when the model class is created (the precise details of how this is done are unimportant here). </font><font id="38">This is because the field classes aren’t necessary when you’re just creating and modifying attributes. </font><font id="39">Instead, they provide the machinery for converting between the attribute value and what is stored in the database or sent to the <a class="reference internal" href="../topics/serialization.html"><em>serializer</em></a>.</font></p>
<p><font id="40">Keep this in mind when creating your own custom fields. </font><font id="41">The Django <tt class="docutils literal"><span class="pre">Field</span></tt> subclass you write provides the machinery for converting between your Python instances and the database/serializer values in various ways (there are differences between storing a value and using a value for lookups, for example). </font><font id="42">If this sounds a bit tricky, don’t worry – it will become clearer in the examples below. </font><font id="43">Just remember that you will often end up creating two classes when you want a custom field:</font></p>
<ul class="simple">
<li><font id="215">The first class is the Python object that your users will manipulate. </font><font id="216">They will assign it to the model attribute, they will read from it for displaying purposes, things like that. </font><font id="217">This is the <tt class="docutils literal"><span class="pre">Hand</span></tt> class in our example.</font></li>
<li><font id="218">The second class is the <tt class="docutils literal"><span class="pre">Field</span></tt> subclass. </font><font id="219">This is the class that knows how to convert your first class back and forth between its permanent storage form and the Python form.</font></li>
</ul>
</div>
</div>
<div class="section" id="s-writing-a-field-subclass">
<span id="writing-a-field-subclass"></span><h2><font id="190">Writing a field subclass</font><a class="headerlink" href="custom-model-fields.html#writing-a-field-subclass" title="Permalink to this headline">¶</a></h2>
<p><font id="44">When planning your <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> subclass, first give some thought to which existing <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> class your new field is most similar to. </font><font id="45">Can you subclass an existing Django field and save yourself some work? </font><font id="46">If not, you should subclass the <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> class, from which everything is descended.</font></p>
<p><font id="47">Initializing your new field is a matter of separating out any arguments that are specific to your case from the common arguments and passing the latter to the <tt class="docutils literal"><span class="pre">__init__()</span></tt> method of <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> (or your parent class).</font></p>
<p><font id="48">In our example, we’ll call our field <tt class="docutils literal"><span class="pre">HandField</span></tt>. </font><font id="49">(It’s a good idea to call your <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> subclass <tt class="docutils literal"><span class="pre">&lt;Something&gt;Field</span></tt>, so it’s easily identifiable as a <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> subclass.) </font><font id="50">It doesn’t behave like any existing field, so we’ll subclass directly from <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a>:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s">"A hand of cards (bridge style)"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">'max_length'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">104</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HandField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="51">Our <tt class="docutils literal"><span class="pre">HandField</span></tt> accepts most of the standard field options (see the list below), but we ensure it has a fixed length, since it only needs to hold 52 card values plus their suits; </font><font id="52">104 characters in total.</font></p>
<div class="admonition note">
<p class="first admonition-title"><font id="53">Note</font></p>
<p><font id="54">Many of Django’s model fields accept options that they don’t do anything with. </font><font id="55">For example, you can pass both <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.editable" title="django.db.models.Field.editable"><tt class="xref py py-attr docutils literal"><span class="pre">editable</span></tt></a> and <a class="reference internal" href="../ref/models/fields.html#django.db.models.DateField.auto_now" title="django.db.models.DateField.auto_now"><tt class="xref py py-attr docutils literal"><span class="pre">auto_now</span></tt></a> to a <a class="reference internal" href="../ref/models/fields.html#django.db.models.DateField" title="django.db.models.DateField"><tt class="xref py py-class docutils literal"><span class="pre">django.db.models.DateField</span></tt></a> and it will simply ignore the <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.editable" title="django.db.models.Field.editable"><tt class="xref py py-attr docutils literal"><span class="pre">editable</span></tt></a> parameter (<a class="reference internal" href="../ref/models/fields.html#django.db.models.DateField.auto_now" title="django.db.models.DateField.auto_now"><tt class="xref py py-attr docutils literal"><span class="pre">auto_now</span></tt></a> being set implies <tt class="docutils literal"><span class="pre">editable=False</span></tt>). </font><font id="56">No error is raised in this case.</font></p>
<p class="last"><font id="57">This behavior simplifies the field classes, because they don’t need to check for options that aren’t necessary. </font><font id="58">They just pass all the options to the parent class and then don’t use them later on. </font><font id="59">It’s up to you whether you want your fields to be more strict about the options they select, or to use the simpler, more permissive behavior of the current fields.</font></p>
</div>
<p><font id="60">The <tt class="docutils literal"><span class="pre">Field.__init__()</span></tt> method takes the following parameters:</font></p>
<ul class="simple">
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.verbose_name" title="django.db.models.Field.verbose_name"><font id="220">verbose_name</font></a></li>
<li><font id="221"><tt class="docutils literal"><span class="pre">name</span></tt></font></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.primary_key" title="django.db.models.Field.primary_key"><font id="222">primary_key</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.CharField.max_length" title="django.db.models.CharField.max_length"><font id="223">max_length</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.unique" title="django.db.models.Field.unique"><font id="224">unique</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.blank" title="django.db.models.Field.blank"><font id="225">blank</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.null" title="django.db.models.Field.null"><font id="226">null</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_index" title="django.db.models.Field.db_index"><font id="227">db_index</font></a></li>
<li><font id="228"><tt class="docutils literal"><span class="pre">rel</span></tt>: Used for related fields (like <a class="reference internal" href="../ref/models/fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKey</span></tt></a>). </font><font id="229">For advanced use only.</font></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.default" title="django.db.models.Field.default"><font id="230">default</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.editable" title="django.db.models.Field.editable"><font id="231">editable</font></a></li>
<li><font id="232"><tt class="docutils literal"><span class="pre">serialize</span></tt>: If <tt class="docutils literal"><span class="pre">False</span></tt>, the field will not be serialized when the model is passed to Django’s <a class="reference internal" href="../topics/serialization.html"><em>serializers</em></a>. </font><font id="233">Defaults to <tt class="docutils literal"><span class="pre">True</span></tt>.</font></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.unique_for_date" title="django.db.models.Field.unique_for_date"><font id="234">unique_for_date</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.unique_for_month" title="django.db.models.Field.unique_for_month"><font id="235">unique_for_month</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.unique_for_year" title="django.db.models.Field.unique_for_year"><font id="236">unique_for_year</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.choices" title="django.db.models.Field.choices"><font id="237">choices</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.help_text" title="django.db.models.Field.help_text"><font id="238">help_text</font></a></li>
<li><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_column" title="django.db.models.Field.db_column"><font id="239">db_column</font></a></li>
<li><font id="240"><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_tablespace" title="django.db.models.Field.db_tablespace"><tt class="xref py py-attr docutils literal"><span class="pre">db_tablespace</span></tt></a>: Only for index creation, if the backend supports <a class="reference internal" href="../topics/db/tablespaces.html"><em>tablespaces</em></a>. </font><font id="241">You can usually ignore this option.</font></li>
<li><font id="242"><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.auto_created" title="django.db.models.Field.auto_created"><tt class="xref py py-attr docutils literal"><span class="pre">auto_created</span></tt></a>: <tt class="docutils literal"><span class="pre">True</span></tt> if the field was automatically created, as for the <a class="reference internal" href="../ref/models/fields.html#django.db.models.OneToOneField" title="django.db.models.OneToOneField"><tt class="xref py py-class docutils literal"><span class="pre">OneToOneField</span></tt></a> used by model inheritance. </font><font id="243">For advanced use only.</font></li>
</ul>
<p><font id="61">All of the options without an explanation in the above list have the same meaning they do for normal Django fields. </font><font id="62">See the <a class="reference internal" href="../ref/models/fields.html"><em>field documentation</em></a> for examples and details.</font></p>
<div class="section" id="s-field-deconstruction">
<span id="s-custom-field-deconstruct-method"></span><span id="field-deconstruction"></span><span id="custom-field-deconstruct-method"></span><h3><font id="195">Field deconstruction</font><a class="headerlink" href="custom-model-fields.html#field-deconstruction" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<span class="title">New in Django 1.7:</span> <p><font id="63"><tt class="docutils literal"><span class="pre">deconstruct()</span></tt> is part of the migrations framework in Django 1.7 and above. </font><font id="64">If you have custom fields from previous versions they will need this method added before you can use them with migrations.</font></p>
</div>
<p><font id="65">The counterpoint to writing your <tt class="docutils literal"><span class="pre">__init__()</span></tt> method is writing the <tt class="docutils literal"><span class="pre">deconstruct()</span></tt> method. </font><font id="66">This method tells Django how to take an instance of your new field and reduce it to a serialized form - in particular, what arguments to pass to <tt class="docutils literal"><span class="pre">__init__()</span></tt> to re-create it.</font></p>
<p><font id="67">If you haven’t added any extra options on top of the field you inherited from, then there’s no need to write a new <tt class="docutils literal"><span class="pre">deconstruct()</span></tt> method. </font><font id="68">If, however, you’re, changing the arguments passed in <tt class="docutils literal"><span class="pre">__init__()</span></tt> (like we are in <tt class="docutils literal"><span class="pre">HandField</span></tt>), you’ll need to supplement the values being passed.</font></p>
<p><font id="69">The contract of <tt class="docutils literal"><span class="pre">deconstruct()</span></tt> is simple; </font><font id="70">it returns a tuple of four items: the field’s attribute name, the full import path of the field class, the positional arguments (as a list), and the keyword arguments (as a dict). </font><font id="71">Note this is different from the <tt class="docutils literal"><span class="pre">deconstruct()</span></tt> method <a class="reference internal" href="../topics/migrations.html#custom-deconstruct-method"><em>for custom classes</em></a> which returns a tuple of three things.</font></p>
<p><font id="72">As a custom field author, you don’t need to care about the first two values; </font><font id="73">the base <tt class="docutils literal"><span class="pre">Field</span></tt> class has all the code to work out the field’s attribute name and import path. </font><font id="74">You do, however, have to care about the positional and keyword arguments, as these are likely the things you are changing.</font></p>
<p><font id="75">For example, in our <tt class="docutils literal"><span class="pre">HandField</span></tt> class we’re always forcibly setting max_length in <tt class="docutils literal"><span class="pre">__init__()</span></tt>. </font><font id="76">The <tt class="docutils literal"><span class="pre">deconstruct()</span></tt> method on the base <tt class="docutils literal"><span class="pre">Field</span></tt> class will see this and try to return it in the keyword arguments; </font><font id="77">thus, we can drop it from the keyword arguments for readability:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">'max_length'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">104</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HandField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">HandField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">deconstruct</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">"max_length"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
</pre></div>
</div>
<p><font id="78">If you add a new keyword argument, you need to write code to put its value into <tt class="docutils literal"><span class="pre">kwargs</span></tt> yourself:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">CommaSepField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="s">"Implements comma-separated storage of lists"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s">","</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CommaSepField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CommaSepField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">deconstruct</span><span class="p">()</span>
        <span class="c"># Only include kwarg if it's not the default</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">!=</span> <span class="s">","</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">'separator'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
</pre></div>
</div>
<p><font id="79">More complex examples are beyond the scope of this document, but remember - for any configuration of your Field instance, <tt class="docutils literal"><span class="pre">deconstruct()</span></tt> must return arguments that you can pass to <tt class="docutils literal"><span class="pre">__init__</span></tt> to reconstruct that state.</font></p>
<p><font id="80">Pay extra attention if you set new default values for arguments in the <tt class="docutils literal"><span class="pre">Field</span></tt> superclass; </font><font id="81">you want to make sure they’re always included, rather than disappearing if they take on the old default value.</font></p>
<p><font id="82">In addition, try to avoid returning values as positional arguments; </font><font id="83">where possible, return values as keyword arguments for maximum future compatibility. </font><font id="84">Of course, if you change the names of things more often than their position in the constructor’s argument list, you might prefer positional, but bear in mind that people will be reconstructing your field from the serialized version for quite a while (possibly years), depending how long your migrations live for.</font></p>
<p><font id="85">You can see the results of deconstruction by looking in migrations that include the field, and you can test deconstruction in unit tests by just deconstructing and reconstructing the field:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">my_field_instance</span><span class="o">.</span><span class="n">deconstruct</span><span class="p">()</span>
<span class="n">new_instance</span> <span class="o">=</span> <span class="n">MyField</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">my_field_instance</span><span class="o">.</span><span class="n">some_attribute</span><span class="p">,</span> <span class="n">new_instance</span><span class="o">.</span><span class="n">some_attribute</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="s-documenting-your-custom-field">
<span id="documenting-your-custom-field"></span><h3><font id="196">Documenting your custom field</font><a class="headerlink" href="custom-model-fields.html#documenting-your-custom-field" title="Permalink to this headline">¶</a></h3>
<p><font id="86">As always, you should document your field type, so users will know what it is. </font><font id="87">In addition to providing a docstring for it, which is useful for developers, you can also allow users of the admin app to see a short description of the field type via the <a class="reference internal" href="../ref/contrib/admin/admindocs.html"><em>django.contrib.admindocs</em></a> application. </font><font id="88">To do this simply provide descriptive text in a <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.description" title="django.db.models.Field.description"><tt class="xref py py-attr docutils literal"><span class="pre">description</span></tt></a> class attribute of your custom field. </font><font id="89">In the above example, the description displayed by the <tt class="docutils literal"><span class="pre">admindocs</span></tt> application for a <tt class="docutils literal"><span class="pre">HandField</span></tt> will be ‘A hand of cards (bridge style)’.</font></p>
<p><font id="90">In the <a class="reference internal" href="../ref/contrib/admin/admindocs.html#module-django.contrib.admindocs" title="django.contrib.admindocs: Django's admin documentation generator."><tt class="xref py py-mod docutils literal"><span class="pre">django.contrib.admindocs</span></tt></a> display, the field description is interpolated with <tt class="docutils literal"><span class="pre">field.__dict__</span></tt> which allows the description to incorporate arguments of the field. </font><font id="91">For example, the description for <a class="reference internal" href="../ref/models/fields.html#django.db.models.CharField" title="django.db.models.CharField"><tt class="xref py py-class docutils literal"><span class="pre">CharField</span></tt></a> is:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">"String (up to </span><span class="si">%(max_length)s</span><span class="s">)"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="s-useful-methods">
<span id="useful-methods"></span><h3><font id="197">Useful methods</font><a class="headerlink" href="custom-model-fields.html#useful-methods" title="Permalink to this headline">¶</a></h3>
<p><font id="92">Once you’ve created your <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> subclass, you might consider overriding a few standard methods, depending on your field’s behavior. </font><font id="93">The list of methods below is in approximately decreasing order of importance, so start from the top.</font></p>
<div class="section" id="s-custom-database-types">
<span id="s-id1"></span><span id="custom-database-types"></span><span id="id1"></span><h4><font id="206">Custom database types</font><a class="headerlink" href="custom-model-fields.html#custom-database-types" title="Permalink to this headline">¶</a></h4>
<p><font id="94">Say you’ve created a PostgreSQL custom type called <tt class="docutils literal"><span class="pre">mytype</span></tt>. </font><font id="95">You can subclass <tt class="docutils literal"><span class="pre">Field</span></tt> and implement the <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a> method, like so:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">MytypeField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'mytype'</span>
</pre></div>
</div>
<p><font id="96">Once you have <tt class="docutils literal"><span class="pre">MytypeField</span></tt>, you can use it in any model, just like any other <tt class="docutils literal"><span class="pre">Field</span></tt> type:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">something_else</span> <span class="o">=</span> <span class="n">MytypeField</span><span class="p">()</span>
</pre></div>
</div>
<p><font id="97">If you aim to build a database-agnostic application, you should account for differences in database column types. </font><font id="98">For example, the date/time column type in PostgreSQL is called <tt class="docutils literal"><span class="pre">timestamp</span></tt>, while the same column in MySQL is called <tt class="docutils literal"><span class="pre">datetime</span></tt>. </font><font id="99">The simplest way to handle this in a <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a> method is to check the <tt class="docutils literal"><span class="pre">connection.settings_dict['ENGINE']</span></tt> attribute.</font></p>
<p><font id="100">For example:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyDateField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">'ENGINE'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'django.db.backends.mysql'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'datetime'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'timestamp'</span>
</pre></div>
</div>
<p><font id="101">The <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a> method is called by Django when the framework constructs the <tt class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></tt> statements for your application – that is, when you first create your tables. </font><font id="102">It is also called when constructing a <tt class="docutils literal"><span class="pre">WHERE</span></tt> clause that includes the model field – that is, when you retrieve data using QuerySet methods like <tt class="docutils literal"><span class="pre">get()</span></tt>, <tt class="docutils literal"><span class="pre">filter()</span></tt>, and <tt class="docutils literal"><span class="pre">exclude()</span></tt> and have the model field as an argument. </font><font id="103">It’s not called at any other time, so it can afford to execute slightly complex code, such as the <tt class="docutils literal"><span class="pre">connection.settings_dict</span></tt> check in the above example.</font></p>
<p><font id="104">Some database column types accept parameters, such as <tt class="docutils literal"><span class="pre">CHAR(25)</span></tt>, where the parameter <tt class="docutils literal"><span class="pre">25</span></tt> represents the maximum column length. </font><font id="105">In cases like these, it’s more flexible if the parameter is specified in the model rather than being hard-coded in the <tt class="docutils literal"><span class="pre">db_type()</span></tt> method. </font><font id="106">For example, it wouldn’t make much sense to have a <tt class="docutils literal"><span class="pre">CharMaxlength25Field</span></tt>, shown here:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This is a silly example of hard-coded parameters.</span>
<span class="k">class</span> <span class="nc">CharMaxlength25Field</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'char(25)'</span>

<span class="c"># In the model:</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">my_field</span> <span class="o">=</span> <span class="n">CharMaxlength25Field</span><span class="p">()</span>
</pre></div>
</div>
<p><font id="107">The better way of doing this would be to make the parameter specifiable at run time – i.e., when the class is instantiated. </font><font id="108">To do that, just implement <tt class="docutils literal"><span class="pre">Field.__init__()</span></tt>, like so:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This is a much more flexible example.</span>
<span class="k">class</span> <span class="nc">BetterCharField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BetterCharField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'char(</span><span class="si">%s</span><span class="s">)'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>

<span class="c"># In the model:</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">my_field</span> <span class="o">=</span> <span class="n">BetterCharField</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="109">Finally, if your column requires truly complex SQL setup, return <tt class="docutils literal"><span class="pre">None</span></tt> from <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a>. </font><font id="110">This will cause Django’s SQL creation code to skip over this field. </font><font id="111">You are then responsible for creating the column in the right table in some other way, of course, but this gives you a way to tell Django to get out of the way.</font></p>
</div>
<div class="section" id="s-converting-values-to-python-objects">
<span id="s-id2"></span><span id="converting-values-to-python-objects"></span><span id="id2"></span><h4><font id="207">Converting values to Python objects</font><a class="headerlink" href="custom-model-fields.html#converting-values-to-python-objects" title="Permalink to this headline">¶</a></h4>
<div class="versionchanged">
<span class="title">Changed in Django 1.8:</span> <p><font id="112">Historically, Django provided a metaclass called <tt class="docutils literal"><span class="pre">SubfieldBase</span></tt> which always called <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.to_python" title="django.db.models.Field.to_python"><tt class="xref py py-meth docutils literal"><span class="pre">to_python()</span></tt></a> on assignment. </font><font id="113">This did not play nicely with custom database transformations, aggregation, or values queries, so it has been replaced with <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.from_db_value" title="django.db.models.Field.from_db_value"><tt class="xref py py-meth docutils literal"><span class="pre">from_db_value()</span></tt></a>.</font></p>
</div>
<p><font id="114">If your custom <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field" title="django.db.models.Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> class deals with data structures that are more complex than strings, dates, integers, or floats, then you may need to override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.from_db_value" title="django.db.models.Field.from_db_value"><tt class="xref py py-meth docutils literal"><span class="pre">from_db_value()</span></tt></a> and <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.to_python" title="django.db.models.Field.to_python"><tt class="xref py py-meth docutils literal"><span class="pre">to_python()</span></tt></a>.</font></p>
<p><font id="115">If present for the field subclass, <tt class="docutils literal"><span class="pre">from_db_value()</span></tt> will be called in all circumstances when the data is loaded from the database, including in aggregates and <a class="reference internal" href="../ref/models/querysets.html#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><tt class="xref py py-meth docutils literal"><span class="pre">values()</span></tt></a> calls.</font></p>
<p><font id="116"><tt class="docutils literal"><span class="pre">to_python()</span></tt> is called by deserialization and during the <a class="reference internal" href="../ref/models/instances.html#django.db.models.Model.clean" title="django.db.models.Model.clean"><tt class="xref py py-meth docutils literal"><span class="pre">clean()</span></tt></a> method used from forms.</font></p>
<p><font id="117">As a general rule, <tt class="docutils literal"><span class="pre">to_python()</span></tt> should deal gracefully with any of the following arguments:</font></p>
<ul class="simple">
<li><font id="244">An instance of the correct type (e.g., <tt class="docutils literal"><span class="pre">Hand</span></tt> in our ongoing example).</font></li>
<li><font id="245">A string</font></li>
<li><font id="246"><tt class="docutils literal"><span class="pre">None</span></tt> </font><font id="247">(if the field allows <tt class="docutils literal"><span class="pre">null=True</span></tt>)</font></li>
</ul>
<p><font id="118">In our <tt class="docutils literal"><span class="pre">HandField</span></tt> class, we’re storing the data as a VARCHAR field in the database, so we need to be able to process strings and <tt class="docutils literal"><span class="pre">None</span></tt> in the <tt class="docutils literal"><span class="pre">from_db_value()</span></tt>. </font><font id="119">In <tt class="docutils literal"><span class="pre">to_python()</span></tt>, we need to also handle <tt class="docutils literal"><span class="pre">Hand</span></tt> instances:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">def</span> <span class="nf">parse_hand</span><span class="p">(</span><span class="n">hand_string</span><span class="p">):</span>
    <span class="sd">"""Takes a string of cards and splits into a full hand."""</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">'.{26}'</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">'..'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">p2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p1</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">hand_string</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Invalid input for a Hand instance"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Hand</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">from_db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">parse_hand</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Hand</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">parse_hand</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="120">Notice that we always return a <tt class="docutils literal"><span class="pre">Hand</span></tt> instance from these methods. </font><font id="121">That’s the Python object type we want to store in the model’s attribute.</font></p>
<p><font id="122">For <tt class="docutils literal"><span class="pre">to_python()</span></tt>, if anything goes wrong during value conversion, you should raise a <a class="reference internal" href="../ref/exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><tt class="xref py py-exc docutils literal"><span class="pre">ValidationError</span></tt></a> exception.</font></p>
</div>
<div class="section" id="s-converting-python-objects-to-query-values">
<span id="s-id3"></span><span id="converting-python-objects-to-query-values"></span><span id="id3"></span><h4><font id="208">Converting Python objects to query values</font><a class="headerlink" href="custom-model-fields.html#converting-python-objects-to-query-values" title="Permalink to this headline">¶</a></h4>
<p><font id="123">Since using a database requires conversion in both ways, if you override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.to_python" title="django.db.models.Field.to_python"><tt class="xref py py-meth docutils literal"><span class="pre">to_python()</span></tt></a> you also have to override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_prep_value" title="django.db.models.Field.get_prep_value"><tt class="xref py py-meth docutils literal"><span class="pre">get_prep_value()</span></tt></a> to convert Python objects back to query values.</font></p>
<p><font id="124">For example:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">get_prep_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">north</span><span class="p">,</span>
                <span class="n">value</span><span class="o">.</span><span class="n">east</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">south</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">west</span><span class="p">)])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title"><font id="125">Warning</font></p>
<p class="last"><font id="126">If your custom field uses the <tt class="docutils literal"><span class="pre">CHAR</span></tt>, <tt class="docutils literal"><span class="pre">VARCHAR</span></tt> or <tt class="docutils literal"><span class="pre">TEXT</span></tt> types for MySQL, you must make sure that <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_prep_value" title="django.db.models.Field.get_prep_value"><tt class="xref py py-meth docutils literal"><span class="pre">get_prep_value()</span></tt></a> always returns a string type. </font><font id="127">MySQL performs flexible and unexpected matching when a query is performed on these types and the provided value is an integer, which can cause queries to include unexpected objects in their results. </font><font id="128">This problem cannot occur if you always return a string type from <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_prep_value" title="django.db.models.Field.get_prep_value"><tt class="xref py py-meth docutils literal"><span class="pre">get_prep_value()</span></tt></a>.</font></p>
</div>
</div>
<div class="section" id="s-converting-query-values-to-database-values">
<span id="s-id4"></span><span id="converting-query-values-to-database-values"></span><span id="id4"></span><h4><font id="209">Converting query values to database values</font><a class="headerlink" href="custom-model-fields.html#converting-query-values-to-database-values" title="Permalink to this headline">¶</a></h4>
<p><font id="129">Some data types (for example, dates) need to be in a specific format before they can be used by a database backend. </font><font id="130"><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_db_prep_value" title="django.db.models.Field.get_db_prep_value"><tt class="xref py py-meth docutils literal"><span class="pre">get_db_prep_value()</span></tt></a> is the method where those conversions should be made. </font><font id="131">The specific connection that will be used for the query is passed as the <tt class="docutils literal"><span class="pre">connection</span></tt> parameter. </font><font id="132">This allows you to use backend-specific conversion logic if it is required.</font></p>
<p><font id="133">For example, Django uses the following method for its <a class="reference internal" href="../ref/models/fields.html#django.db.models.BinaryField" title="django.db.models.BinaryField"><tt class="xref py py-class docutils literal"><span class="pre">BinaryField</span></tt></a>:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_db_prep_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">prepared</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BinaryField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_db_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">prepared</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">Database</span><span class="o">.</span><span class="n">Binary</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p><font id="134">In case your custom field needs a special conversion when being saved that is not the same as the conversion used for normal query parameters, you can override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_db_prep_save" title="django.db.models.Field.get_db_prep_save"><tt class="xref py py-meth docutils literal"><span class="pre">get_db_prep_save()</span></tt></a>.</font></p>
</div>
<div class="section" id="s-preprocessing-values-before-saving">
<span id="s-id5"></span><span id="preprocessing-values-before-saving"></span><span id="id5"></span><h4><font id="210">Preprocessing values before saving</font><a class="headerlink" href="custom-model-fields.html#preprocessing-values-before-saving" title="Permalink to this headline">¶</a></h4>
<p><font id="135">If you want to preprocess the value just before saving, you can use <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.pre_save" title="django.db.models.Field.pre_save"><tt class="xref py py-meth docutils literal"><span class="pre">pre_save()</span></tt></a>. </font><font id="136">For example, Django’s <a class="reference internal" href="../ref/models/fields.html#django.db.models.DateTimeField" title="django.db.models.DateTimeField"><tt class="xref py py-class docutils literal"><span class="pre">DateTimeField</span></tt></a> uses this method to set the attribute correctly in the case of <a class="reference internal" href="../ref/models/fields.html#django.db.models.DateField.auto_now" title="django.db.models.DateField.auto_now"><tt class="xref py py-attr docutils literal"><span class="pre">auto_now</span></tt></a> or <a class="reference internal" href="../ref/models/fields.html#django.db.models.DateField.auto_now_add" title="django.db.models.DateField.auto_now_add"><tt class="xref py py-attr docutils literal"><span class="pre">auto_now_add</span></tt></a>.</font></p>
<p><font id="137">If you do override this method, you must return the value of the attribute at the end. </font><font id="138">You should also update the model’s attribute if you make any changes to the value so that code holding references to the model will always see the correct value.</font></p>
</div>
<div class="section" id="s-preparing-values-for-use-in-database-lookups">
<span id="s-id6"></span><span id="preparing-values-for-use-in-database-lookups"></span><span id="id6"></span><h4><font id="211">Preparing values for use in database lookups</font><a class="headerlink" href="custom-model-fields.html#preparing-values-for-use-in-database-lookups" title="Permalink to this headline">¶</a></h4>
<p><font id="139">As with value conversions, preparing a value for database lookups is a two phase process.</font></p>
<p><font id="140"><a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_prep_lookup" title="django.db.models.Field.get_prep_lookup"><tt class="xref py py-meth docutils literal"><span class="pre">get_prep_lookup()</span></tt></a> performs the first phase of lookup preparation: type conversion and data validation.</font></p>
<p><font id="141">Prepares the <tt class="docutils literal"><span class="pre">value</span></tt> for passing to the database when used in a lookup (a <tt class="docutils literal"><span class="pre">WHERE</span></tt> constraint in SQL). </font><font id="142">The <tt class="docutils literal"><span class="pre">lookup_type</span></tt> parameter will be one of the valid Django filter lookups: <tt class="docutils literal"><span class="pre">exact</span></tt>, <tt class="docutils literal"><span class="pre">iexact</span></tt>, <tt class="docutils literal"><span class="pre">contains</span></tt>, <tt class="docutils literal"><span class="pre">icontains</span></tt>, <tt class="docutils literal"><span class="pre">gt</span></tt>, <tt class="docutils literal"><span class="pre">gte</span></tt>, <tt class="docutils literal"><span class="pre">lt</span></tt>, <tt class="docutils literal"><span class="pre">lte</span></tt>, <tt class="docutils literal"><span class="pre">in</span></tt>, <tt class="docutils literal"><span class="pre">startswith</span></tt>, <tt class="docutils literal"><span class="pre">istartswith</span></tt>, <tt class="docutils literal"><span class="pre">endswith</span></tt>, <tt class="docutils literal"><span class="pre">iendswith</span></tt>, <tt class="docutils literal"><span class="pre">range</span></tt>, <tt class="docutils literal"><span class="pre">year</span></tt>, <tt class="docutils literal"><span class="pre">month</span></tt>, <tt class="docutils literal"><span class="pre">day</span></tt>, <tt class="docutils literal"><span class="pre">isnull</span></tt>, <tt class="docutils literal"><span class="pre">search</span></tt>, <tt class="docutils literal"><span class="pre">regex</span></tt>, and <tt class="docutils literal"><span class="pre">iregex</span></tt>.</font></p>
<div class="versionadded">
<span class="title">New in Django 1.7:</span> <p><font id="143">If you are using <a class="reference internal" href="custom-lookups.html"><em>Custom lookups</em></a> the <tt class="docutils literal"><span class="pre">lookup_type</span></tt> can be any <tt class="docutils literal"><span class="pre">lookup_name</span></tt> used by the project’s custom lookups.</font></p>
</div>
<p><font id="144">Your method must be prepared to handle all of these <tt class="docutils literal"><span class="pre">lookup_type</span></tt> values and should raise either a <tt class="docutils literal"><span class="pre">ValueError</span></tt> if the <tt class="docutils literal"><span class="pre">value</span></tt> is of the wrong sort (a list when you were expecting an object, for example) or a <tt class="docutils literal"><span class="pre">TypeError</span></tt> if your field does not support that type of lookup. </font><font id="145">For many fields, you can get by with handling the lookup types that need special handling for your field and pass the rest to the <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_db_prep_lookup" title="django.db.models.Field.get_db_prep_lookup"><tt class="xref py py-meth docutils literal"><span class="pre">get_db_prep_lookup()</span></tt></a> method of the parent class.</font></p>
<p><font id="146">If you needed to implement <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_db_prep_save" title="django.db.models.Field.get_db_prep_save"><tt class="xref py py-meth docutils literal"><span class="pre">get_db_prep_save()</span></tt></a>, you will usually need to implement <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_prep_lookup" title="django.db.models.Field.get_prep_lookup"><tt class="xref py py-meth docutils literal"><span class="pre">get_prep_lookup()</span></tt></a>. </font><font id="147">If you don’t, <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_prep_value" title="django.db.models.Field.get_prep_value"><tt class="xref py py-meth docutils literal"><span class="pre">get_prep_value()</span></tt></a> will be called by the default implementation, to manage <tt class="docutils literal"><span class="pre">exact</span></tt>, <tt class="docutils literal"><span class="pre">gt</span></tt>, <tt class="docutils literal"><span class="pre">gte</span></tt>, <tt class="docutils literal"><span class="pre">lt</span></tt>, <tt class="docutils literal"><span class="pre">lte</span></tt>, <tt class="docutils literal"><span class="pre">in</span></tt> and <tt class="docutils literal"><span class="pre">range</span></tt> lookups.</font></p>
<p><font id="148">You may also want to implement this method to limit the lookup types that could be used with your custom field type.</font></p>
<p><font id="149">Note that, for <tt class="docutils literal"><span class="pre">"range"</span></tt> and <tt class="docutils literal"><span class="pre">"in"</span></tt> lookups, <tt class="docutils literal"><span class="pre">get_prep_lookup</span></tt> will receive a list of objects (presumably of the right type) and will need to convert them to a list of things of the right type for passing to the database. </font><font id="285">Most of the time, you can reuse <tt class="docutils literal"><span class="pre">get_prep_value()</span></tt>, or at least factor out some common pieces.</font></p>
<p><font id="150">For example, the following code implements <tt class="docutils literal"><span class="pre">get_prep_lookup</span></tt> to limit the accepted lookup types to <tt class="docutils literal"><span class="pre">exact</span></tt> and <tt class="docutils literal"><span class="pre">in</span></tt>:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">get_prep_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># We only handle 'exact' and 'in'. All others are errors.</span>
        <span class="k">if</span> <span class="n">lookup_type</span> <span class="o">==</span> <span class="s">'exact'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">lookup_type</span> <span class="o">==</span> <span class="s">'in'</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">'Lookup type </span><span class="si">%r</span><span class="s"> not supported.'</span> <span class="o">%</span> <span class="n">lookup_type</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="151">For performing database-specific data conversions required by a lookup, you can override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_db_prep_lookup" title="django.db.models.Field.get_db_prep_lookup"><tt class="xref py py-meth docutils literal"><span class="pre">get_db_prep_lookup()</span></tt></a>.</font></p>
</div>
<div class="section" id="s-specifying-the-form-field-for-a-model-field">
<span id="s-specifying-form-field-for-model-field"></span><span id="specifying-the-form-field-for-a-model-field"></span><span id="specifying-form-field-for-model-field"></span><h4><font id="212">Specifying the form field for a model field</font><a class="headerlink" href="custom-model-fields.html#specifying-the-form-field-for-a-model-field" title="Permalink to this headline">¶</a></h4>
<p><font id="152">To customize the form field used by <a class="reference internal" href="../topics/forms/modelforms.html#django.forms.ModelForm" title="django.forms.ModelForm"><tt class="xref py py-class docutils literal"><span class="pre">ModelForm</span></tt></a>, you can override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.formfield" title="django.db.models.Field.formfield"><tt class="xref py py-meth docutils literal"><span class="pre">formfield()</span></tt></a>.</font></p>
<p><font id="153">The form field class can be specified via the <tt class="docutils literal"><span class="pre">form_class</span></tt> and <tt class="docutils literal"><span class="pre">choices_form_class</span></tt> arguments; </font><font id="154">the latter is used if the field has choices specified, the former otherwise. </font><font id="155">If these arguments are not provided, <a class="reference internal" href="../ref/forms/fields.html#django.forms.CharField" title="django.forms.CharField"><tt class="xref py py-class docutils literal"><span class="pre">CharField</span></tt></a> or <a class="reference internal" href="../ref/forms/fields.html#django.forms.TypedChoiceField" title="django.forms.TypedChoiceField"><tt class="xref py py-class docutils literal"><span class="pre">TypedChoiceField</span></tt></a> will be used.</font></p>
<p><font id="156">All of the <tt class="docutils literal"><span class="pre">kwargs</span></tt> dictionary is passed directly to the form field’s <tt class="docutils literal"><span class="pre">__init__()</span></tt> method. </font><font id="157">Normally, all you need to do is set up a good default for the <tt class="docutils literal"><span class="pre">form_class</span></tt> (and maybe <tt class="docutils literal"><span class="pre">choices_form_class</span></tt>) argument and then delegate further handling to the parent class. </font><font id="158">This might require you to write a custom form field (and even a form widget). </font><font id="159">See the <a class="reference internal" href="../topics/forms/index.html"><em>forms documentation</em></a> for information about this.</font></p>
<p><font id="160">Continuing our ongoing example, we can write the <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.formfield" title="django.db.models.Field.formfield"><tt class="xref py py-meth docutils literal"><span class="pre">formfield()</span></tt></a> method as:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">formfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># This is a fairly standard way to set up some defaults</span>
        <span class="c"># while letting the caller override them.</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s">'form_class'</span><span class="p">:</span> <span class="n">MyFormField</span><span class="p">}</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">HandField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
</pre></div>
</div>
<p><font id="161">This assumes we’ve imported a <tt class="docutils literal"><span class="pre">MyFormField</span></tt> field class (which has its own default widget). </font><font id="162">This document doesn’t cover the details of writing custom form fields.</font></p>
</div>
<div class="section" id="s-emulating-built-in-field-types">
<span id="s-id7"></span><span id="emulating-built-in-field-types"></span><span id="id7"></span><h4><font id="213">Emulating built-in field types</font><a class="headerlink" href="custom-model-fields.html#emulating-built-in-field-types" title="Permalink to this headline">¶</a></h4>
<p><font id="163">If you have created a <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a> method, you don’t need to worry about <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_internal_type" title="django.db.models.Field.get_internal_type"><tt class="xref py py-meth docutils literal"><span class="pre">get_internal_type()</span></tt></a> – it won’t be used much. </font><font id="164">Sometimes, though, your database storage is similar in type to some other field, so you can use that other field’s logic to create the right column.</font></p>
<p><font id="165">For example:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">get_internal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'CharField'</span>
</pre></div>
</div>
<p><font id="166">No matter which database backend we are using, this will mean that <a class="reference internal" href="../ref/django-admin.html#django-admin-migrate"><tt class="xref std std-djadmin docutils literal"><span class="pre">migrate</span></tt></a> and other SQL commands create the right column type for storing a string.</font></p>
<p><font id="167">If <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.get_internal_type" title="django.db.models.Field.get_internal_type"><tt class="xref py py-meth docutils literal"><span class="pre">get_internal_type()</span></tt></a> returns a string that is not known to Django for the database backend you are using – that is, it doesn’t appear in <tt class="docutils literal"><span class="pre">django.db.backends.&lt;db_name&gt;.base.</span></tt></font><font id="168">DatabaseWrapper.data_types – the string will still be used by the serializer, but the default <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a> method will return <tt class="docutils literal"><span class="pre">None</span></tt>. </font><font id="169">See the documentation of <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.db_type" title="django.db.models.Field.db_type"><tt class="xref py py-meth docutils literal"><span class="pre">db_type()</span></tt></a> for reasons why this might be useful. </font><font id="170">Putting a descriptive string in as the type of the field for the serializer is a useful idea if you’re ever going to be using the serializer output in some other place, outside of Django.</font></p>
</div>
<div class="section" id="s-converting-field-data-for-serialization">
<span id="s-converting-model-field-to-serialization"></span><span id="converting-field-data-for-serialization"></span><span id="converting-model-field-to-serialization"></span><h4><font id="214">Converting field data for serialization</font><a class="headerlink" href="custom-model-fields.html#converting-field-data-for-serialization" title="Permalink to this headline">¶</a></h4>
<p><font id="171">To customize how the values are serialized by a serializer, you can override <a class="reference internal" href="../ref/models/fields.html#django.db.models.Field.value_to_string" title="django.db.models.Field.value_to_string"><tt class="xref py py-meth docutils literal"><span class="pre">value_to_string()</span></tt></a>. </font><font id="172">Calling <tt class="docutils literal"><span class="pre">Field._get_val_from_obj(obj)</span></tt> is the best way to get the value serialized. </font><font id="173">For example, since our <tt class="docutils literal"><span class="pre">HandField</span></tt> uses strings for its data storage anyway, we can reuse some existing conversion code:</font></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HandField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">value_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_val_from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="s-some-general-advice">
<span id="some-general-advice"></span><h3><font id="198">Some general advice</font><a class="headerlink" href="custom-model-fields.html#some-general-advice" title="Permalink to this headline">¶</a></h3>
<p><font id="174">Writing a custom field can be a tricky process, particularly if you’re doing complex conversions between your Python types and your database and serialization formats. </font><font id="175">Here are a couple of tips to make things go more smoothly:</font></p>
<ol class="arabic simple">
<li><font id="248">Look at the existing Django fields (in <tt class="file docutils literal"><span class="pre">django/db/models/fields/__init__.py</span></tt>) for inspiration. </font><font id="249">Try to find a field that’s similar to what you want and extend it a little bit, instead of creating an entirely new field from scratch.</font></li>
<li><font id="250">Put a <tt class="docutils literal"><span class="pre">__str__()</span></tt> (<tt class="docutils literal"><span class="pre">__unicode__()</span></tt> on Python 2) method on the class you’re wrapping up as a field. </font><font id="251">There are a lot of places where the default behavior of the field code is to call <a class="reference internal" href="http://python.usyiyi.cn/django/ref/utils.html#django.utils.encoding.force_text" title="django.utils.encoding.force_text"><tt class="xref py py-func docutils literal"><span class="pre">force_text()</span></tt></a> on the value. </font><font id="252">(In our examples in this document, <tt class="docutils literal"><span class="pre">value</span></tt> would be a <tt class="docutils literal"><span class="pre">Hand</span></tt> instance, not a <tt class="docutils literal"><span class="pre">HandField</span></tt>). </font><font id="253">So if your <tt class="docutils literal"><span class="pre">__str__()</span></tt> method (<tt class="docutils literal"><span class="pre">__unicode__()</span></tt> on Python 2) automatically converts to the string form of your Python object, you can save yourself a lot of work.</font></li>
</ol>
</div>
</div>
<div class="section" id="s-writing-a-filefield-subclass">
<span id="writing-a-filefield-subclass"></span><h2><font id="191">Writing a </font><tt class="docutils literal"><span class="pre">FileField</span></tt></h2>
<p><font id="176">In addition to the above methods, fields that deal with files have a few other special requirements which must be taken into account. </font><font id="177">The majority of the mechanics provided by <tt class="docutils literal"><span class="pre">FileField</span></tt>, such as controlling database storage and retrieval, can remain unchanged, leaving subclasses to deal with the challenge of supporting a particular type of file.</font></p>
<p><font id="178">Django provides a <tt class="docutils literal"><span class="pre">File</span></tt> class, which is used as a proxy to the file’s contents and operations. </font><font id="179">This can be subclassed to customize how the file is accessed, and what methods are available. </font><font id="180">It lives at <tt class="docutils literal"><span class="pre">django.db.models.fields.files</span></tt>, and its default behavior is explained in the <a class="reference internal" href="../ref/files/file.html"><em>file documentation</em></a>.</font></p>
<p><font id="181">Once a subclass of <tt class="docutils literal"><span class="pre">File</span></tt> is created, the new <tt class="docutils literal"><span class="pre">FileField</span></tt> subclass must be told to use it. </font><font id="182">To do so, simply assign the new <tt class="docutils literal"><span class="pre">File</span></tt> subclass to the special <tt class="docutils literal"><span class="pre">attr_class</span></tt> attribute of the <tt class="docutils literal"><span class="pre">FileField</span></tt> subclass.</font></p>
<div class="section" id="s-a-few-suggestions">
<span id="a-few-suggestions"></span><h3><font id="199">A few suggestions</font><a class="headerlink" href="custom-model-fields.html#a-few-suggestions" title="Permalink to this headline">¶</a></h3>
<p><font id="183">In addition to the above details, there are a few guidelines which can greatly improve the efficiency and readability of the field’s code.</font></p>
<ol class="arabic simple">
<li><font id="254">The source for Django’s own <tt class="docutils literal"><span class="pre">ImageField</span></tt> (in <tt class="docutils literal"><span class="pre">django/db/models/fields/files.py</span></tt>) is a great example of how to subclass <tt class="docutils literal"><span class="pre">FileField</span></tt> to support a particular type of file, as it incorporates all of the techniques described above.</font></li>
<li><font id="255">Cache file attributes wherever possible. </font><font id="256">Since files may be stored in remote storage systems, retrieving them may cost extra time, or even money, that isn’t always necessary. </font><font id="257">Once a file is retrieved to obtain some data about its content, cache as much of that data as possible to reduce the number of times the file must be retrieved on subsequent calls for that information.</font></li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="yui-b" id="sidebar">
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<h3><font id="200">Table Of Contents</font></h3>
<ul>
<li><a class="reference internal" href="custom-model-fields.html#"><font id="258">Writing custom model fields</font></a><ul>
<li><a class="reference internal" href="custom-model-fields.html#introduction"><font id="259">Introduction</font></a><ul>
<li><a class="reference internal" href="custom-model-fields.html#our-example-object"><font id="260">Our example object</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="custom-model-fields.html#background-theory"><font id="261">Background theory</font></a><ul>
<li><a class="reference internal" href="custom-model-fields.html#database-storage"><font id="262">Database storage</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#what-does-a-field-class-do"><font id="263">What does a field class do?</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="custom-model-fields.html#writing-a-field-subclass"><font id="264">Writing a field subclass</font></a><ul>
<li><a class="reference internal" href="custom-model-fields.html#field-deconstruction"><font id="265">Field deconstruction</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#documenting-your-custom-field"><font id="266">Documenting your custom field</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#useful-methods"><font id="267">Useful methods</font></a><ul>
<li><a class="reference internal" href="custom-model-fields.html#custom-database-types"><font id="268">Custom database types</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#converting-values-to-python-objects"><font id="269">Converting values to Python objects</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#converting-python-objects-to-query-values"><font id="270">Converting Python objects to query values</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#converting-query-values-to-database-values"><font id="271">Converting query values to database values</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#preprocessing-values-before-saving"><font id="272">Preprocessing values before saving</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#preparing-values-for-use-in-database-lookups"><font id="273">Preparing values for use in database lookups</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#specifying-the-form-field-for-a-model-field"><font id="274">Specifying the form field for a model field</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#emulating-built-in-field-types"><font id="275">Emulating built-in field types</font></a></li>
<li><a class="reference internal" href="custom-model-fields.html#converting-field-data-for-serialization"><font id="276">Converting field data for serialization</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="custom-model-fields.html#some-general-advice"><font id="277">Some general advice</font></a></li>
</ul>
</li>
<li><a class="reference internal" href="custom-model-fields.html#writing-a-filefield-subclass"><font id="278">None</font></a><ul>
<li><a class="reference internal" href="custom-model-fields.html#a-few-suggestions"><font id="279">A few suggestions</font></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><font id="201">Browse</font></h3>
<ul>
<li><font id="280">Prev: <a href="custom-management-commands.html">Writing custom django-admin commands</a></font></li>
<li><font id="281">Next: <a href="custom-lookups.html">Custom Lookups</a></font></li>
</ul>
<h3><font id="202">You are here:</font></h3>
<ul>
<li>
<a href="../index.html"><font id="282">Django 1.8.2.dev20150513143415 documentation</font></a>
<ul><li><a href="http://python.usyiyi.cn/django/howto/index.html">“How-to” guides</a>
<ul><li><font id="283">Writing custom model fields</font></li></ul>
</li></ul>
</li>
</ul>
<h3><font id="203">This Page</font></h3>
<ul class="this-page-menu">
<li><a href="http://python.usyiyi.cn/django/_sources/howto/custom-model-fields.txt" rel="nofollow"><font id="284">Show Source</font></a></li>
</ul>
<div id="searchbox" style="display: none">
<h3><font id="204">Quick search</font></h3>
<form action="http://python.usyiyi.cn/django/search.html" class="search" method="get">
<input name="q" type="text"/>
<input type="submit" value="Go"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
<p class="searchtip" style="font-size: 90%"><font id="184"> Enter search terms or a module, class or function name. </font></p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<h3><font id="205">Last update:</font></h3>
<p class="topless"><font id="185">May 13, 2015</font></p>
</div>
</div>
<div id="ft">
<div class="nav">
    « <a href="custom-management-commands.html" title="Writing custom django-admin commands">previous</a>
     |
    <a accesskey="U" href="http://python.usyiyi.cn/django/howto/index.html" title="&amp;#8220;How-to&amp;#8221; guides">up</a>
   |
    <a href="custom-lookups.html" title="Custom Lookups">next</a> »</div>
</div>
</div>
<div class="clearer"></div>
</div>
<div id="disqus_thread"></div><br>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'djangocn'; // required: replace example with your forum shortname
    var disqus_identifier = '/django/howto/custom-model-fields;
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<link href="http://python.usyiyi.cn/django/_static/ms_translator.css" rel="stylesheet" type="text/css"/>
<script src="http://python.usyiyi.cn/django/_static/ms_translator.js" type="text/javascript"></script>
<script src="http://python.usyiyi.cn/django/_static/jquery-ui-1.9.2.custom.min.js" type="text/javascript"></script>
<div id="MicrosoftTranslator" style="display:none; position: absolute; z-index: 2147483647; margin: 0px; border: 2px solid rgb(210, 210, 210); padding: 0px; color: rgb(0, 0, 0); background-color: rgb(230, 230, 230); font-family: Arial,Helvetica,Sans-Serif; font-style: normal; font-variant: normal; font-weight: normal; font-size: 12px; line-height: normal; direction: ltr; text-align: left; left: 274px; top: 2048.03px; min-width: 400px;">
    <div id="MSTCClose" style="float: right;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/tooltip_close.gif">
      </a>
    </div>
    
    <div id="MSTCPopDown" style="float: right;" style="display: none;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/popdown.gif">
      </a>
    </div>
    <div id="MSTCPopUP" style="float: right;">
      <a style="display: inline-block; cursor: pointer; text-decoration: none; vertical-align: top; border: 0px none; padding: 4px;">
        <img src="http://python.usyiyi.cn/django/_static/popup.gif">
      </a>
    </div>
    
    <div id="MSTCTitle" style="margin: 4px 4px 8px; font-weight: bold;">原文
    </div>
    
    <div style="direction: ltr; text-align: left;">
      <span id="MSTCOrigion" style="display: inline-block; margin: 0px 4px 4px;"> </span>
    </div>
    
    <div id="MicrosoftTranslatorCommunity" class="MSTCltr">
      <div id="MSTCContent">
        <a id="MSTCExpandLink">
          <span id="MSTCImprove">改进翻译</span>
          <span id="MSTCSuggest">最小化</span>
          <img src="http://python.usyiyi.cn/django/_static/ctftoggledown.gif" id="MSTCToggleDown">
          <img src="http://python.usyiyi.cn/django/_static/ctftoggleup.gif" id="MSTCToggleUp">
        </a>
        <div id="MSTCRootPanel">
          <span id="MSTCLoading" style="display: none;">正在加载...</span>
          <div style="display: none;" id="MSTCTransPanelError">
            <div class="MSTCTableRow">
              <div class="MSTCTransPanelExc MSTCTableCell">
                <img style="border-width:0px;" src="http://python.usyiyi.cn/django/_static/error_exclamation.gif" id="ExclamationImage">
              </div>
              <div class="MSTCTableCell">
                <span id="MSTCTransPanelErrorMsg"></span>
              </div>
            </div>
            <div class="MSTCTableRow">
              <div class="MSTCTableCell"></div>
              <div class="MSTCTableCell MSTCFlipHoriz">
                <input type="image" style="border-width:0px;" src="http://python.usyiyi.cn/django/_static/error_OK.gif" class="MSTCErrorButtons" id="MSTCOKImgBtn" name="MSTCOKImgBtn">
              </div>
            </div>
          </div>
          
          <div id="MSTCTransPanel">
          </div>
          
          <div id="MSTCPrevNextPanel">
            <a id="MSTCPrevLink" style='border-right-width: 1px;border-right-style: solid;padding-right: 5px;'>
              <span>上一页</span>
            </a>
            <a style='color: black; border-right-width: 1px;border-right-style: solid;padding-right: 5px;'>
              <span>第</span>
              <span id="MSTCPage"></span>
              <span>页</span>
            </a>
            <a id="MSTCNextLink" style='padding-left: 5px;'>
              <span>下一页</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>